import{R as le,a as ae,K as X,r as F}from"./constants-V-ZPE83q.js";import{d as T,t as U,w as oe,s as P,r as j,o as ce,c as q,h as se,e as $,N as z}from"./index-B6wo-CfO.js";function re(n){const l=new Map;if(n.forEach(r=>{const{from:v,to:m}=r,[e,o]=v,[x,C]=m;[e,x].forEach(E=>{[o,C].forEach(W=>{const S=`${E},${W}`,Y=l.get(S);Y===void 0?l.set(S,1):Y<=1?l.delete(S):l.set(S,Y-1)})})}),l.size!==4)return null;const a=[],w=[];return l.forEach((r,v)=>{const[m,e]=v.split(",").map(o=>Number.parseInt(o,10));a.push(m),w.push(e)}),{from:[Math.min(...a),Math.min(...w)],to:[Math.max(...a),Math.max(...w)],merge:!0}}function K(n){return n?n.getChildren().filter(a=>a instanceof le):[]}function A(n,l,a){const{width:w,height:r,unit:v}=n;return{x:w?(l-w*v)/2:20,y:r?(a-r*v)/2:50}}function L(n,l){return[(n[0]+l[0])/2,(n[1]+l[1])/2]}function G(n,l){return Math.sqrt(Math.pow(n[0]-l[0],2)+Math.pow(n[1]-l[1],2))}const ve=T({name:"BookcaseEditor",props:{data:{type:Object,required:!1},readonly:{type:Boolean,default:!1},beforeMerge:{type:Function,default:async()=>!0,required:!1},beforeBreak:{type:Function,default:async()=>!0,required:!1}},setup(n,l){const{data:a,readonly:w}=U(n);oe(a,()=>{a.value&&C(a.value)},{immediate:!0});const r=P(),v=P(),m=P(),e=P([]),o=P(ae),x=j();function C(u){if(!r.value)return;const{meta:i,cells:R}=u,{unit:c,fill:f}=i,M=r.value.parentElement,_=(M==null?void 0:M.clientWidth)||300,b=(M==null?void 0:M.clientHeight)||300;x.value=x.value??A(i,_,b);const t=new X.Stage({container:r.value,x:x.value.x,y:x.value.y,width:_,height:b,draggable:!0}),h=new X.Layer;t.add(h),v.value=t,m.value=h;let g=null,D=null,N=0;t.on("touchstart",k=>{const{target:s,evt:I}=k;I.preventDefault();const{touches:d}=I;if(d.length===1&&(K(h).forEach(p=>p.fill(o.value.fill)),e.value=[],g=null,!t.isDragging()&&s instanceof X.Rect&&(t.stopDrag(),K(h).forEach(p=>p.fill(o.value.fill)),s.fill(o.value.fillSelected),e.value.push(s),g=s),h.draw()),d.length===2){t.stopDrag();const p=[d[0].clientX,d[0].clientY],B=[d[1].clientX,d[1].clientY];D=L(p,B),N=G(p,B)}}),t.on("touchmove",k=>{const{target:s,evt:I}=k;I.preventDefault();const{touches:d}=I;if(d.length===1&&!t.isDragging()&&s instanceof X.Rect){if(g!==s){const p=e.value.findIndex(y=>y===s),B=e.value.findIndex(y=>y===g);p===-1?(s.fill(o.value.fillSelected),e.value.push(s)):(e.value.splice(B,1),g==null||g.fill(o.value.fill)),g=s}h.draw()}if(d.length===2){const p=[d[0].clientX,d[0].clientY],B=[d[1].clientX,d[1].clientY],y=L(p,B),H=G(p,B);D||(D=y);const O=[(y[0]-t.x())/t.scaleX(),(y[1]-t.y())/t.scaleY()],V=t.scaleX()*(H/N);t.scaleX(V),t.scaleY(V);const ee=y[0]-D[0],te=y[1]-D[1],ne={x:y[0]-O[0]*V+ee,y:y[1]-O[1]*V+te};t.position(ne),D=y,N=H}}),t.on("touchout",()=>{D=null,N=0}),o.value=i,R.forEach(k=>{const{from:s,to:I}=k,d=s[0]*c,p=s[1]*c,B=(I[1]-s[1])*c,y=(I[0]-s[0])*c,H=new X.Rect({y:p,x:d,width:y,height:B,fill:f,cell:{...k},...F});h.add(H),h.draw()})}ce(()=>{a.value&&C(a.value)});const E=()=>{var R,c;if(w.value)return;if(e.value.length<1)throw new Error("merge should have at least two cells");const u=e.value.map(f=>f.attrs.cell),i=re(u);if(i){e.value.forEach(k=>k.remove());const{unit:f,fill:M}=o.value,{from:_,to:b}=i,t=_[0]*f,h=_[1]*f,g=(b[1]-_[1])*f,D=(b[0]-_[0])*f,N=new X.Rect({y:h,x:t,width:D,height:g,fill:M,cell:{...i},...F});(R=m.value)==null||R.add(N),e.value=[]}else e.value.forEach(f=>{f.fill(o.value.fill)}),e.value=[],alert("cannot merge");return(c=m.value)==null||c.draw(),i},W=()=>{var M,_;if(w.value)return;if(e.value.length!==1)throw new Error("break effect only 1 cell");const u=e.value[0],{attrs:{cell:{from:i,to:R}}}=u,{unit:c,fill:f}=o.value;for(let b=0;b<R[0]-i[0];b++)for(let t=0;t<R[1]-i[1];t++){const h=i[0]+b,g=i[1]+t,D=h*c,N=g*c,k=c,s=c,I=new X.Rect({y:N,x:D,width:s,height:k,fill:f,cell:{from:[h,g],to:[h+1,g+1],merge:!1},...F});(M=m.value)==null||M.add(I)}e.value.forEach(b=>b.remove()),e.value=[],(_=m.value)==null||_.draw()},S=()=>{var R,c;if(w.value)return;const u=K(m.value).filter(f=>f instanceof X.Rect).map(f=>f.attrs.cell);if(!u)return;const i={...a.value,meta:o.value,cells:u};return x.value={x:((R=v.value)==null?void 0:R.x())||20,y:((c=v.value)==null?void 0:c.y())||50},i},Y=()=>e.value.map(u=>u.attrs.cell),Z=()=>{var c;if(!r.value)return;const u=r.value.parentElement,i=(u==null?void 0:u.clientWidth)||300,R=(u==null?void 0:u.clientHeight)||300;x.value=A(o.value,i,R),(c=v.value)==null||c.setPosition({x:x.value.x,y:x.value.y}).scale({x:1,y:1})};return l.expose({mergeCells:E,breakCell:W,getData:S,getActiveCells:Y,resetView:Z}),()=>q("div",{style:{width:"100%",height:"100%"}},[q("div",{ref:r},null)])}}),ue="_readonly_3c9xr_1",ie="_editor_3c9xr_2",J={readonly:ue,editor:ie},Q=20,he=T({name:"BookcaseNameInput",props:{value:{type:String,default:""},isDual:{type:String,default:"editonly"},placeholder:{type:String,default:se("pages.bookcase.bookcaseNmaeInput.defaultPlaceholder",[Q])},onChange:{type:Function}},setup(n){const{value:l,isDual:a,placeholder:w}=U(n),r=j(!1),v=()=>q("div",null,[l.value]),m=()=>q(z,{class:$(J.readonly),readonly:!0,onClick:()=>{r.value=!0},value:l.value},null),e=j(),o=()=>q(z,{class:$(J.editor),ref:e,maxlength:Q,value:l.value,placeholder:w.value,onKeyup:C=>{var E;C.code==="Enter"&&((E=e.value)==null||E.blur(),r.value=!1)},onBlur:()=>{var C,E;r.value=!1,(E=n.onChange)==null||E.call(n,(C=l.value)==null?void 0:C.trim())},onInput:C=>{var E;(E=n.onChange)==null||E.call(n,C)}},null),x=()=>a.value==="editonly"?o():a.value==="readonly"?v():a.value==="dual"?r.value?o():m():v();return()=>x()}});export{he as B,ve as E};
//# sourceMappingURL=BookcaseNameInput-Cop0r9qn.js.map
