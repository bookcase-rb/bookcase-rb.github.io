import{d as C,u as A,a as k,r as d,w as I,b as N,c as n,ap as q,aq as F,B as g,S as w,e as _,i as E,ar as T,as as j,f as x}from"./index-Bk_Q6iwp.js";import{B as R,s as O}from"./index-DdvSRK4j.js";import{a as P,B as V}from"./BasicTopBar-n8OglYHh.js";import{D as z}from"./DeckerLayout-DVgQt0VZ.js";import{B as L}from"./BarcodeDecker-C1NK05yH.js";import"./vue-utils-DtDNsWW1.js";import"./InputGroup-DDkYgE8G.js";import"./Popover-0REC5pKa.js";import"./get-BJieqKi6.js";import"./Image-BOQ1Gr6z.js";import"./create-D3Vn69pI.js";import"./FormItem-CAB1ly-i.js";import"./Rate-BCurNBux.js";import"./InputNumber-CaR5tvaT.js";import"./useTRouter-BIOIhU90.js";const M={"new-book":"_new-book_zpv31_1"};function U(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!E(a)}const re=C({name:"NewBook",setup(){const{t:a}=A({useScope:"global"}),l=q(),p=F(),{message:c}=k(),{dialog:B}=k(),i=d(),r=d();function m(){var t;const{cellId:e,bookcaseId:o}=l.query;return(t=i.value)==null?void 0:t.getFormData().then(u=>{const v=u;if(!v)throw new Error("book form data invalid");if(typeof e!="string"||typeof o!="string")throw new Error("cellId and bookcaseId invalid");return x.book.addBook(v,e,o)})}function y(){m().then(e=>{const{id:o}=e;p.replace({path:`/book/preview/id/${o}`})})}function h(){m().then(()=>{c.success(a("pages.book.new.saveAndAdd.saveSuccess")),p.replace({path:"/book/new",query:{...l.query,isbn:"",t:new Date().getTime()}})})}const f=new AbortController,s=d(!1);function b(e){s.value=!0;const o=f.signal;return O(e,o).catch(t=>{throw t.name!=="AbortError"&&c.error(...T()),t}).finally(()=>{s.value=!1})}I(()=>l.query,e=>{var t;const o=e.isbn;o?b(o).then(u=>{r.value={...u}}).catch(()=>{r.value={isbn:o}}):(r.value={...j},(t=i.value)==null||t.reset())},{immediate:!0}),N(()=>{c.destroyAll(),f.abort()});const D=e=>{let o;return n("div",{class:_(M["new-book"])},[n(P,{loading:s.value,topBar:n(V,{rightSlots:[n(g,{onClick:y},{default:()=>[n(w,{name:"save"},null)]}),n(g,{onClick:h},{default:()=>[n(w,{name:"save-and-plus"},null)]})]},U(o=a("pages.book.new.topbar.title"))?o:{default:()=>[o]})},{default:()=>[n(R,{ref:i,scraping:s.value,data:r.value,onScan:e,onScrape:b},null)]})])},S=e=>n(L,{onBarcodeDetect:o=>new Promise(t=>{B.success({title:a("pages.cell.newBarcodeDialog.title"),content:a("pages.cell.newBarcodeDialog.content",[o]),closable:!1,positiveText:a("common.yes"),negativeText:a("common.no"),onPositiveClick:()=>{r.value={isbn:o},e(),t(!0)},onNegativeClick:()=>{t(!1)}})}),onClose:e},null);return()=>n(z,null,{default:e=>D(e),decker:e=>S(e)})}});export{re as default};
//# sourceMappingURL=NewBook-FCckfUj-.js.map
