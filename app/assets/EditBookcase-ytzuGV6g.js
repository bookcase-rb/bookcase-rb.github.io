import{u as A}from"./useTRouter-sTePj2MT.js";import{d as F,u as R,f as M,s as V,r as y,w as O,g as L,c as t,a as g,B as b,S as m,i as P,e as i,I,F as U}from"./index-DkYgaArx.js";import{B as $,E as G}from"./BookcaseNameInput-CvgzVXVV.js";import{B as H,a as J}from"./BasicTopBar-Dyq_xIRB.js";import{D as K}from"./DeleteConfirmButton-ChuXxxvl.js";import"./constants-D8IofHZa.js";import"./Popconfirm-DQEg8XpO.js";import"./Popover-JWH0sjZb.js";import"./get-T0yiJ2Om.js";const Q="_title_1ryey_6",W="_blur_1ryey_13",u={"edit-bookcase":"_edit-bookcase_1ryey_1",title:Q,blur:W};function j(o){return typeof o=="function"||Object.prototype.toString.call(o)==="[object Object]"&&!P(o)}const ne=F({name:"BookcaseEdit",setup(){const{t:o}=R({useScope:"global"}),{route:S,router:B}=A(),{dialog:T,message:n}=M("top"),v=V(),c=y(""),r=y(!1);O(()=>S.params,a=>{const e=a.id;e&&(r.value=!0,i.bookcase.queryBookcaseById(e).then(l=>{v.value=l,c.value=(l==null?void 0:l.name)||""}).finally(()=>{r.value=!1}))},{immediate:!0});const s=y(),d=y(!1),N=()=>{var e;const a=(e=s.value)==null?void 0:e.getActiveCells();i.book.queryBooksCountByCellIds(a.map(l=>l.id||"")).then(l=>{var f;l===0?(d.value=!0,(f=s.value)==null||f.mergeCells()):T.warning({closable:!1,maskClosable:!1,title:o("pages.bookcase.edit.mergeDialog.title"),content:()=>t(U,null,[t(I,{scope:"global",keypath:"pages.bookcase.edit.mergeDialog.content.count",tag:"div"},j(l)?l:{default:()=>[l]}),t(I,{scope:"global",keypath:"pages.bookcase.edit.mergeDialog.content.tip",tag:"div"},null)]),positiveText:o("pages.bookcase.edit.mergeDialog.positiveText"),negativeText:o("common.forgetIt"),onPositiveClick(){var h,D;const k=(h=s.value)==null?void 0:h.mergeCells(),p=(D=s.value)==null?void 0:D.getData();k&&i.bookcase.updateBookcase({...p,name:c.value}).then(_=>{const w=_.cells.find(C=>C.from.join(",")===k.from.join(",")&&C.to.join(",")===k.to.join(","));w&&i.book.moveBooksToNewCell(a.map(C=>C.id||""),w.id||"").then(()=>{n.success(o("pages.bookcase.edit.mergeDialog.mergeFinished"))}).finally(()=>{v.value=_,d.value=!1})})}})})},E=()=>{var e,l;const a=(e=s.value)==null?void 0:e.getActiveCells();if(a.length===1){const f=a[0].id;f?i.book.queryBooksByCellId(f).then(k=>{var p;k.length>0?n.error(o("pages.bookcase.edit.break.cannotBreak")):(d.value=!0,(p=s.value)==null||p.breakCell())}):(d.value=!0,(l=s.value)==null||l.breakCell())}},q=()=>{var e;const a=(e=s.value)==null?void 0:e.getActiveCells();if(a.length===0){n.warning(o("pages.bookcase.edit.manageCell.noCell"));return}if(a.length>1){n.warning(o("pages.bookcase.edit.manageCell.tooManyCells"));return}if(!a[0].id||d.value){n.warning(o("pages.bookcase.edit.manageCell.unsave"));return}B.push({path:`/cell/${a[0].id}`})},x=()=>{var e;const a=(e=v.value)==null?void 0:e.id;a&&(r.value=!0,i.bookcase.deleteBookcase(a).then(()=>{B.back()}).then(()=>{r.value=!1}))},z=()=>{var e;if(!c.value){n.error(o("pages.bookcase.edit.save.titleRequired"));return}r.value=!0;const a=(e=s.value)==null?void 0:e.getData();i.bookcase.updateBookcase({...a,name:c.value}).then(l=>{v.value=l,n.success(o("pages.bookcase.edit.save.success"))}).then(()=>{r.value=!1,d.value=!1})};return L(()=>{n.destroyAll()}),()=>{let a;return t(J,{loading:r.value,topBar:t(H,{rightSlots:[t(b,{onClick:z},{default:()=>[t(m,{name:"save"},null)]}),t(K,{onConfirm:x},{default:()=>[t(m,{name:"delete"},null)]})]},j(a=o("pages.bookcase.edit.topbar.title"))?a:{default:()=>[a]}),toolBar:[t(b,{class:g(u.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:()=>{var e;(e=s.value)==null||e.resetView()}},{default:()=>[t(m,{name:"restore"},null)]}),t(b,{class:g(u.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:N},{default:()=>[t(m,{name:"mergeCells"},null)]}),t(b,{class:g(u.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:E},{default:()=>[t(m,{name:"breakCells"},null)]}),t(b,{class:g(u.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:q},{default:()=>[t(m,{name:"openCase"},null)]})]},{default:()=>[t("div",{class:g(u["edit-bookcase"])},[t("div",{class:g(u.title,u.blur)},[t($,{isDual:"dual",value:c.value,onChange:e=>{c.value=e}},null)]),t(G,{ref:s,data:v.value},null)])]})}}});export{ne as default};
//# sourceMappingURL=EditBookcase-ytzuGV6g.js.map
