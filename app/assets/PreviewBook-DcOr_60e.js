import{x as ee,y as te,E as oe,Z as le,G as P,d as I,a5 as ae,J as V,r as k,L as T,a6 as ie,v as S,P as se,t as j,u as $,c as e,e as ne,b as w,F as H,I as ce,a7 as re,w as q,a as O,B as L,S as ue,i as de}from"./index-CG3a7rsK.js";import{u as K}from"./useTRouter-CEo93KYf.js";import{l as C,N as pe,g as W}from"./utils-BFS3ofrN.js";import{t as ve,N as fe,a as me}from"./Image-BFb-LyKR.js";import{a as be,B as E}from"./BasicTopBar-G56vP4uT.js";import{D as ge}from"./DoubleDeckerContainer-mmyIr3na.js";import{D as ke}from"./DeckerLayout-C0cuFgMg.js";import{K as R,r as he}from"./constants-CvtHFQAB.js";import"./Popover-DpIVwY6I.js";import"./get-CoZZFLI9.js";const we=ee({name:"Ellipsis",common:te,peers:{Tooltip:ve}}),ye=oe("ellipsis",{overflow:"hidden"},[le("line-clamp",`
 white-space: nowrap;
 display: inline-block;
 vertical-align: bottom;
 max-width: 100%;
 `),P("line-clamp",`
 display: -webkit-inline-box;
 -webkit-box-orient: vertical;
 `),P("cursor-pointer",`
 cursor: pointer;
 `)]);function z(t){return`${t}-ellipsis--line-clamp`}function F(t,a){return`${t}-ellipsis--cursor-${a}`}const _e=Object.assign(Object.assign({},V.props),{expandTrigger:String,lineClamp:[Number,String],tooltip:{type:[Boolean,Object],default:!0}}),Be=I({name:"Ellipsis",inheritAttrs:!1,props:_e,slots:Object,setup(t,{slots:a,attrs:p}){const s=ae(),v=V("Ellipsis","-ellipsis",ye,we,t,s),g=k(null),u=k(null),d=k(null),i=k(!1),o=T(()=>{const{lineClamp:l}=t,{value:f}=i;return l!==void 0?{textOverflow:"","-webkit-line-clamp":f?"":l}:{textOverflow:f?"":"ellipsis","-webkit-line-clamp":""}});function n(){let l=!1;const{value:f}=i;if(f)return!0;const{value:b}=g;if(b){const{lineClamp:h}=t;if(m(b),h!==void 0)l=b.scrollHeight<=b.offsetHeight;else{const{value:y}=u;y&&(l=y.getBoundingClientRect().width<=b.getBoundingClientRect().width)}x(b,l)}return l}const c=T(()=>t.expandTrigger==="click"?()=>{var l;const{value:f}=i;f&&((l=d.value)===null||l===void 0||l.setShow(!1)),i.value=!f}:void 0);ie(()=>{var l;t.tooltip&&((l=d.value)===null||l===void 0||l.setShow(!1))});const r=()=>S("span",Object.assign({},se(p,{class:[`${s.value}-ellipsis`,t.lineClamp!==void 0?z(s.value):void 0,t.expandTrigger==="click"?F(s.value,"pointer"):void 0],style:o.value}),{ref:"triggerRef",onClick:c.value,onMouseenter:t.expandTrigger==="click"?n:void 0}),t.lineClamp?a:S("span",{ref:"triggerInnerRef"},a));function m(l){if(!l)return;const f=o.value,b=z(s.value);t.lineClamp!==void 0?B(l,b,"add"):B(l,b,"remove");for(const h in f)l.style[h]!==f[h]&&(l.style[h]=f[h])}function x(l,f){const b=F(s.value,"pointer");t.expandTrigger==="click"&&!f?B(l,b,"add"):B(l,b,"remove")}function B(l,f,b){b==="add"?l.classList.contains(f)||l.classList.add(f):l.classList.contains(f)&&l.classList.remove(f)}return{mergedTheme:v,triggerRef:g,triggerInnerRef:u,tooltipRef:d,handleClick:c,renderTrigger:r,getTooltipDisabled:n}},render(){var t;const{tooltip:a,renderTrigger:p,$slots:s}=this;if(a){const{mergedTheme:v}=this;return S(fe,Object.assign({ref:"tooltipRef",placement:"top"},a,{getDisabled:this.getTooltipDisabled,theme:v.peers.Tooltip,themeOverrides:v.peerOverrides.Tooltip}),{trigger:p,default:(t=s.tooltip)!==null&&t!==void 0?t:s.default})}else return p()}}),Ie="_item_1fqoq_1",_={"book-details":"_book-details_1fqoq_1",item:Ie,"book-cover-image":"_book-cover-image_1fqoq_10"},Ce=I({name:"BookDetails",props:{bookData:{type:Object,default:()=>({})},onRateChange:{type:Function}},setup(t){const{bookData:a}=j(t),{t:p}=$({useScope:"global"}),s=T(()=>{var g,u,d;const v=(u=(g=a.value)==null?void 0:g.covers)==null?void 0:u[0];return W(v,(d=a.value)==null?void 0:d.title)});return()=>{var v,g,u,d,i,o,n,c,r;return e("div",{class:w(_["book-details"])},[e("h1",null,[(v=a.value)==null?void 0:v.title]),e("p",null,[(g=a.value)==null?void 0:g.isbn]),e("p",null,[p("pages.book.preview.detail.author"),ne("："),C((u=a.value)==null?void 0:u.authors,p("pages.book.preview.detail.noAuthor"),_.item)]),e("p",null,[e(pe,{value:(d=a.value)==null?void 0:d.rating,allowHalf:!0,onUpdateValue:t.onRateChange},null)]),e("p",null,[e(me,{class:w(_["book-cover-image"]),src:s.value,renderToolbar:({nodes:m})=>e(H,null,[m.zoomIn,m.resizeToOriginalSize,m.zoomOut])},null)]),e("h3",null,[p("pages.book.preview.detail.details")]),e("p",null,[C((i=a.value)==null?void 0:i.publishers,p("pages.book.preview.detail.noPublisher"),_.item)]),e("p",null,[(o=a.value)==null?void 0:o.publishDate]),e("p",null,[C((n=a.value)==null?void 0:n.languages,p("pages.book.preview.detail.noLanguage"),_.item)]),e("p",null,[e(ce,{scope:"global",keypath:"pages.book.preview.detail.numberOfPages"},{default:()=>{var m;return[(m=a.value)==null?void 0:m.numberOfPages]}})]),e("p",null,[C((c=a.value)==null?void 0:c.tags,p("pages.book.preview.detail.noTags"),_.item)]),e("p",null,[C((r=a.value)==null?void 0:r.subjects,p("pages.book.preview.detail.noSubject"),_.item)]),e("p",null,[e("h3",null,[p("pages.book.preview.detail.summary")]),e("div",null,[e(Be,{expandTrigger:"click",lineClamp:5,tooltip:!1},{default:()=>{var m;return[(m=a.value)==null?void 0:m.summary]}})])])])}}}),Te="_flip_1j32v_23",M={"duplicate-books-icon":"_duplicate-books-icon_1j32v_1",flip:Te},xe=I({name:"DuplicateBooksIcon",props:{cover:{type:Blob},title:{type:String}},setup(t){const{cover:a,title:p}=j(t),s=T(()=>W(a.value,p.value)),v=k(!1);return setTimeout(()=>{re(()=>{v.value=!0})},1e3),()=>e("div",{class:w(M["duplicate-books-icon"],{[M.flip]:v.value}),style:{"--background-image":`url(${s.value})`}},["⬜️"])}}),D={"bookcase-preview-container":"_bookcase-preview-container_1pkbt_1","bookcase-preview":"_bookcase-preview_1pkbt_1","bookcase-preview-image":"_bookcase-preview-image_1pkbt_15"},Se=I({name:"BookcasePreview",props:{bookcaseId:{type:String,required:!1},selectedCellId:{type:String,required:!1},isLocated:{type:Boolean,default:!1},onSizeLoad:{type:Function,required:!1}},setup(t){const{bookcaseId:a,selectedCellId:p,isLocated:s}=j(t),{t:v}=$({useScope:"global"}),g=k();q(()=>a.value,o=>{o&&O.bookcase.queryBookcaseById(o).then(n=>{n&&(d(n),g.value=n.name)})},{immediate:!0});const u=k();function d(o){const{meta:n,cells:c}=o,{unit:r,fill:m,fillSelected:x}=n,B=(n.width*r||300)+4,l=(n.height*r||300)+4,f=new R.Stage({container:document.createElement("div"),x:2,y:2,width:B,height:l,draggable:!1}),b=new R.Layer;f.add(b),c.forEach(h=>{const{from:y,to:N,id:G}=h,J=y[0]*r,Y=y[1]*r,Z=(N[1]-y[1])*r,Q=(N[0]-y[0])*r,X=new R.Rect({y:Y,x:J,width:Q,height:Z,fill:G===p.value?x:m,cell:{...h},...he});b.add(X),b.draw()}),f.toBlob({}).then(h=>{u.value=h})}const i=o=>{var r,m;const c=(r=o.target.parentElement)==null?void 0:r.parentElement;(m=t.onSizeLoad)==null||m.call(t,c.clientWidth,c.clientHeight)};return()=>e("div",{class:w(D["bookcase-preview-container"])},[e("div",{class:w(D["bookcase-preview"])},[e("img",{class:w(D["bookcase-preview-image"]),src:u.value&&URL.createObjectURL(u.value),alt:g.value,onLoad:i},null),e("div",null,[e("span",null,[g.value]),e("span",null,[s.value?v("pages.bookcase.preview.current"):""])])])])}}),U={"book-location":"_book-location_1s333_1","preview-card":"_preview-card_1s333_7"},Le=I({name:"BookLocation",props:{bookcaseIds:{type:Array,default:()=>[]}},setup(t){const{router:a}=K(),p=k([]),s=k(!1),v=k([]),g=k(0);return q(p.value,u=>{if(u.filter(d=>d!==void 0).length===t.bookcaseIds.length){s.value=!0;const d=[],i=[0,0];for(let o=0;o<u.length;o++)i[0]<=i[1]?(d.push([0,i[0]]),i[0]+=u[o]):(d.push([1,i[1]]),i[1]+=u[o]);v.value=d,g.value=Math.max(...i)}}),()=>e("div",{class:w(U["book-location"]),style:{height:`${g.value}px`}},[t.bookcaseIds.map((u,d)=>{const i=v.value[d]||[0,0],o=i[0]===0?"0%":"100%",n=i[1]+"px";return e("div",{class:w(U["preview-card"]),style:{visibility:s.value?"visible":"hidden",transform:`translate(${o}, ${n})`},onClick:()=>{a.push(`/cell/${u.cellId}`)}},[e(Se,{key:u.bookcaseId,bookcaseId:u.bookcaseId,selectedCellId:u.cellId,onSizeLoad:(c,r)=>{p.value[d]=r},isLocated:d===0},null)])})])}}),Re={"preview-book":"_preview-book_ozp5a_1"};function A(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!de(t)}const Me=I({name:"PreviewBook",setup(){const{t}=$({useScope:"global"}),{route:a,router:p}=K(),s=k(),v=k([]);q(()=>a.params,i=>{const{isbn:o,id:n}=i;n?O.book.queryRelatedBooksByBookId(n).then(c=>{if(c!=null&&c.length){const[r,...m]=c;s.value=r,v.value=m||[]}}):o&&O.book.queryFirstBookByIsbn(o).then(c=>{if(c!=null&&c.length){const[r,...m]=c;s.value=r,v.value=m||[]}})},{immediate:!0});function g(){var o;const i=(o=s.value)==null?void 0:o.id;i&&p.push({path:`/book/edit/id/${i}`,replace:!0})}const u=i=>e("div",{class:w(Re["preview-book"])},[e(be,{topBar:e(E,{rightSlots:[v.value.length?e(L,{onClick:i},{default:()=>{var o,n,c;return[e(xe,{cover:(n=(o=s.value)==null?void 0:o.covers)==null?void 0:n[0],title:(c=s.value)==null?void 0:c.title},null)]}}):e(H,null,null),e(L,{onClick:g},{default:()=>[e(ue,{name:"pencil"},null)]})]},{default:()=>{var o;return[((o=s.value)==null?void 0:o.title)||"-"]}})},{default:()=>[e(Ce,{bookData:s.value},null)]})]),d=i=>{let o,n;const c=[s.value,...v.value].filter(r=>!!r).map(r=>({bookcaseId:r.bookcaseId,cellId:r.cellId}));return e(ke,{topBar:e(E,{leftSlots:[e(L,{text:!0,onClick:i},A(o=t("common.close"))?o:{default:()=>[o]})]},A(n=t("pages.book.preview.decker.topbar.title"))?n:{default:()=>[n]})},{default:()=>[e(Le,{bookcaseIds:c},null)]})};return()=>e(ge,null,{default:u,decker:d})}});export{Me as default};
