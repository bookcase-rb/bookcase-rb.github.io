import{a as ne,g as ae,K as B,r as M,b as W,c as K,e as O,f as V}from"./utils-7_mGPhvC.js";import{d as G,t as J,w as oe,s as P,r as q,c as Y,h as ce,e as A,N as L}from"./index-B3qSu1dX.js";const fe=G({name:"BookcaseEditor",props:{data:{type:Object,required:!1},readonly:{type:Boolean,default:!1},beforeMerge:{type:Function,default:async()=>!0,required:!1},beforeBreak:{type:Function,default:async()=>!0,required:!1}},setup(b,_){const{data:N,readonly:X}=J(b);oe(N,l=>{l&&(C.value?x(l):I(l))},{immediate:!0});const w=P(),C=P(),D=P(),a=P([]),o=P(ne),m=q();function I(l){if(!w.value){console.error("container not found");return}const{meta:n,cells:g}=l,{unit:t}=n,r=w.value.parentElement,s=(r==null?void 0:r.clientWidth)||300,f=(r==null?void 0:r.clientHeight)||300;m.value=m.value??K(n,s,f);const e=new B.Stage({container:w.value,x:m.value.x,y:m.value.y,width:s,height:f,draggable:!0}),i=new B.Layer;e.add(i),C.value=e,D.value=i;let d=null,v=null,E=0;e.on("touchstart",R=>{const{target:c,evt:p}=R;p.preventDefault();const{touches:u}=p;if(u.length===1&&(W(i).forEach(y=>y.fill(o.value.fill)),a.value=[],d=null,!e.isDragging()&&c instanceof B.Rect&&(e.stopDrag(),W(i).forEach(y=>y.fill(o.value.fill)),c.fill(o.value.fillSelected),a.value.push(c),d=c),i.draw()),u.length===2){e.stopDrag();const y=[u[0].clientX,u[0].clientY],k=[u[1].clientX,u[1].clientY];v=O(y,k),E=V(y,k)}}),e.on("touchmove",R=>{const{target:c,evt:p}=R;p.preventDefault();const{touches:u}=p;if(u.length===1&&!e.isDragging()&&c instanceof B.Rect){if(d!==c){const y=a.value.findIndex(h=>h===c),k=a.value.findIndex(h=>h===d);y===-1?(c.fill(o.value.fillSelected),a.value.push(c)):(a.value.splice(k,1),d==null||d.fill(o.value.fill)),d=c}i.draw()}if(u.length===2){const y=[u[0].clientX,u[0].clientY],k=[u[1].clientX,u[1].clientY],h=O(y,k),F=V(y,k);v||(v=h);const H=[(h[0]-e.x())/e.scaleX(),(h[1]-e.y())/e.scaleY()],S=e.scaleX()*(F/E);e.scaleX(S),e.scaleY(S);const ee=h[0]-v[0],te=h[1]-v[1],le={x:h[0]-H[0]*S+ee,y:h[1]-H[1]*S+te};e.position(le),v=h,E=F}}),e.on("touchend",()=>{v=null,E=0}),o.value=n,g.forEach(R=>{const{from:c,to:p,isNotEmpty:u}=R,y=c[0]*t,k=c[1]*t,h=(p[1]-c[1])*t,F=(p[0]-c[0])*t,H=u?o.value.fillNotEmpty:o.value.fill,S=new B.Rect({y:k,x:y,width:F,height:h,fill:H,cell:{...R},...M});i.add(S),i.draw()})}function x(l){const{meta:n,cells:g}=l,t=D.value;t&&(t.destroyChildren(),g.forEach(r=>{const{from:s,to:f}=r,e=s[0]*n.unit,i=s[1]*n.unit,d=(f[1]-s[1])*n.unit,v=(f[0]-s[0])*n.unit,E=new B.Rect({y:i,x:e,width:v,height:d,fill:n.fill,cell:{...r},...M});t.add(E)}),t.batchDraw())}const Q=()=>new Promise((l,n)=>{var r,s;X.value&&n("readonly mode cannot merge cells"),a.value.length<1&&n("merge should have at least two cells");const g=a.value.map(f=>f.attrs.cell),t=ae(g);if(t){a.value.forEach(u=>u.remove());const{unit:f,fill:e}=o.value,{from:i,to:d}=t,v=i[0]*f,E=i[1]*f,R=(d[1]-i[1])*f,c=(d[0]-i[0])*f,p=new B.Rect({y:E,x:v,width:c,height:R,fill:e,cell:{...t},...M});(r=D.value)==null||r.add(p),a.value=[],l(t)}else a.value.forEach(f=>{f.fill(o.value.fill)}),a.value=[],n("merge fail");(s=D.value)==null||s.draw()}),T=()=>{var s,f;if(X.value)return;if(a.value.length!==1)throw new Error("break effect only 1 cell");const l=a.value[0],{attrs:{cell:{from:n,to:g}}}=l,{unit:t,fill:r}=o.value;for(let e=0;e<g[0]-n[0];e++)for(let i=0;i<g[1]-n[1];i++){const d=n[0]+e,v=n[1]+i,E=d*t,R=v*t,c=t,p=t,u=new B.Rect({y:R,x:E,width:p,height:c,fill:r,cell:{from:[d,v],to:[d+1,v+1],merge:!1},...M});(s=D.value)==null||s.add(u)}a.value.forEach(e=>e.remove()),a.value=[],(f=D.value)==null||f.draw()},U=()=>{var g,t,r;if(X.value)return;const l=W(D.value).filter(s=>s instanceof B.Rect).map(s=>s.attrs.cell);if(!l)return;const n={...N.value,meta:o.value,cells:l};return m.value={x:((g=C.value)==null?void 0:g.x())||20,y:((t=C.value)==null?void 0:t.y())||50},(r=C.value)==null?void 0:r.toBlob({x:m.value.x-1,y:m.value.y-1,width:o.value.width*o.value.unit+2,height:o.value.height*o.value.unit+2}).then(s=>({bookcase:n,thumbnailFile:s}))},Z=()=>a.value.map(l=>l.attrs.cell),$=()=>{var t;if(!w.value)return;const l=w.value.parentElement,n=(l==null?void 0:l.clientWidth)||300,g=(l==null?void 0:l.clientHeight)||300;m.value=K(o.value,n,g),(t=C.value)==null||t.setPosition({x:m.value.x,y:m.value.y}).scale({x:1,y:1})};return _.expose({mergeCells:Q,breakCell:T,getData:U,getActiveCells:Z,resetView:$}),()=>Y("div",{style:{width:"100%",height:"100%"}},[Y("div",{ref:w},null)])}}),se="_readonly_3c9xr_1",ie="_editor_3c9xr_2",j={readonly:se,editor:ie},z=20,de=G({name:"BookcaseNameInput",props:{value:{type:String,default:""},isDual:{type:String,default:"editonly"},placeholder:{type:String,default:ce("pages.bookcase.bookcaseNmaeInput.defaultPlaceholder",[z])},onChange:{type:Function}},setup(b){const{value:_,isDual:N,placeholder:X}=J(b),w=q(!1),C=()=>Y("div",null,[_.value]),D=()=>Y(L,{class:A(j.readonly),readonly:!0,onClick:()=>{w.value=!0},value:_.value},null),a=q(),o=()=>Y(L,{class:A(j.editor),ref:a,maxlength:z,value:_.value,placeholder:X.value,onKeyup:I=>{var x;I.code==="Enter"&&((x=a.value)==null||x.blur(),w.value=!1)},onBlur:()=>{var I,x;w.value=!1,(x=b.onChange)==null||x.call(b,(I=_.value)==null?void 0:I.trim())},onInput:I=>{var x;(x=b.onChange)==null||x.call(b,I)}},null),m=()=>N.value==="editonly"?o():N.value==="readonly"?C():N.value==="dual"?w.value?o():D():C();return()=>m()}});export{de as B,fe as E};
//# sourceMappingURL=BookcaseNameInput-Bc3_XngR.js.map
