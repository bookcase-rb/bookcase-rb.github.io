{"version":3,"file":"BookcasePreview-Ddd2o0bY.js","sources":["../../src/pages/bookcase/bookcasePreview/BookcasePreview.tsx"],"sourcesContent":["/**\n * @file 单个书架预览\n * @author Yangholmes 2025-04-20\n */\n\nimport { defineComponent, PropType, ref, toRefs, watch } from 'vue';\nimport Konva from 'konva';\nimport cn from 'classnames';\nimport { useI18n } from 'vue-i18n';\n\nimport { Bookcase } from '../utils';\nimport { rectOptions } from '../constants';\nimport db from '@/services/db';\n\nimport styles from './bookcasePreview.module.less';\n\nexport default defineComponent({\n  name: 'BookcasePreview',\n  props: {\n    bookcaseId: {\n      type: String,\n      required: false\n    },\n    selectedCellId: {\n      type: String,\n      required: false\n    },\n    isLocated: {\n      type: Boolean,\n      default: false\n    },\n    onSizeLoad: {\n      type: Function as PropType<((width: number, height: number) => void)>,\n      required: false\n    }\n  },\n  setup(props) {\n    const { bookcaseId, selectedCellId, isLocated } = toRefs(props);\n\n    const { t } = useI18n({ useScope: 'global' });\n\n    const bookcaseName = ref<string>();\n\n    watch(() => bookcaseId.value, newValue => {\n      if (newValue) {\n        db.bookcase.queryBookcaseById(newValue).then(res => {\n          if (res) {\n            init(res);\n            bookcaseName.value = res.name;\n          }\n        });\n      }\n    }, { immediate: true });\n\n    const image = ref<Blob>();\n\n    function init(bookcase: Bookcase) {\n      const { meta, cells } = bookcase;\n\n      const { unit, fill, fillSelected } = meta;\n\n      const cWidth = (meta.width * unit || 300) + 4;\n      const cHeight = (meta.height * unit || 300) + 4;\n\n      const stage = new Konva.Stage({\n        container: document.createElement('div'),\n        x: 2,\n        y: 2,\n        width: cWidth,\n        height: cHeight,\n        draggable: false,\n      });\n\n      const layer = new Konva.Layer();\n\n      stage.add(layer);\n\n      cells.forEach(c => {\n        const { from, to, id } = c;\n        const x = from[0] * unit;\n        const y = from[1] * unit;\n        const height = (to[1] - from[1]) * unit;\n        const width = (to[0] - from[0]) * unit;\n\n        const rect = new Konva.Rect({\n          y, x, width, height,\n          fill: id === selectedCellId.value ? fillSelected : fill,\n          cell: {\n            ...c\n          },\n          ...rectOptions\n        });\n        layer.add(rect);\n        layer.draw();\n      });\n\n      stage.toBlob({}).then((img) => {\n        image.value = img as Blob;\n      });\n    }\n\n    const onImageLoaded = (e: Event) => {\n      const self = e.target as HTMLImageElement;\n      const wrapper = self.parentElement?.parentElement as HTMLDivElement;\n      props.onSizeLoad?.(\n        wrapper.clientWidth,\n        wrapper.clientHeight\n      );\n    };\n\n    return () => (<div class={cn(styles['bookcase-preview-container'])}>\n      <div\n        class={cn(styles['bookcase-preview'])}\n      >\n        <img\n          class={cn(styles['bookcase-preview-image'])}\n          src={image.value && URL.createObjectURL(image.value)}\n          alt={bookcaseName.value}\n          onLoad={onImageLoaded}\n        />\n        <div>\n          <span>{bookcaseName.value}</span>\n          <span>{isLocated.value ? t('pages.bookcase.preview.current') : ''}</span>\n        </div>\n      </div>\n    </div>);\n  }\n});\n"],"names":["defineComponent","name","props","bookcaseId","type","String","required","selectedCellId","isLocated","Boolean","default","onSizeLoad","Function","setup","toRefs","t","useI18n","useScope","bookcaseName","ref","watch","value","newValue","db","bookcase","queryBookcaseById","then","res","init","immediate","image","meta","cells","unit","fill","fillSelected","cWidth","width","cHeight","height","stage","Konva","Stage","container","document","createElement","x","y","draggable","layer","Layer","add","forEach","c","from","to","id","rect","Rect","cell","rectOptions","draw","toBlob","img","onImageLoaded","e","wrapper","self","target","parentElement","clientWidth","clientHeight","_createVNode","cn","styles","URL","createObjectURL"],"mappings":"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"}