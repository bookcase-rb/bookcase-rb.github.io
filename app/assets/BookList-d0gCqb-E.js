import{C as D,bj as B,s as G,w as W,bk as V,bl as J,d as Q,t as X,u as Y,r as I,c as d,S as $,e as x,g as P,F as Z,i as ee,f as te,ad as se}from"./index-DG1BSOqx.js";import{c as ne}from"./utils-BWEJTcwZ.js";import{N as ie}from"./Rate-rQNExyl6.js";import{N as oe}from"./Popconfirm-C716FB8M.js";function C(i,r,e){let s=e.initialDeps??[],t;function n(){var l,o,a,h;let c;e.key&&((l=e.debug)!=null&&l.call(e))&&(c=Date.now());const S=i();if(!(S.length!==s.length||S.some((z,k)=>s[k]!==z)))return t;s=S;let y;if(e.key&&((o=e.debug)!=null&&o.call(e))&&(y=Date.now()),t=r(...S),e.key&&((a=e.debug)!=null&&a.call(e))){const z=Math.round((Date.now()-c)*100)/100,k=Math.round((Date.now()-y)*100)/100,E=k/16,M=(_,N)=>{for(_=String(_);_.length<N;)_=" "+_;return _};console.info(`%c⏱ ${M(k,5)} /${M(z,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*E,120))}deg 100% 31%);`,e==null?void 0:e.key)}return(h=e==null?void 0:e.onChange)==null||h.call(e,t),t}return n.updateDeps=l=>{s=l},n}function j(i,r){if(i===void 0)throw new Error("Unexpected undefined");return i}const le=(i,r)=>Math.abs(i-r)<1,re=(i,r,e)=>{let s;return function(...t){i.clearTimeout(s),s=i.setTimeout(()=>r.apply(this,t),e)}},ae=i=>i,ce=i=>{const r=Math.max(i.startIndex-i.overscan,0),e=Math.min(i.endIndex+i.overscan,i.count-1),s=[];for(let t=r;t<=e;t++)s.push(t);return s},he=(i,r)=>{const e=i.scrollElement;if(!e)return;const s=i.targetWindow;if(!s)return;const t=l=>{const{width:o,height:a}=l;r({width:Math.round(o),height:Math.round(a)})};if(t(e.getBoundingClientRect()),!s.ResizeObserver)return()=>{};const n=new s.ResizeObserver(l=>{const o=()=>{const a=l[0];if(a!=null&&a.borderBoxSize){const h=a.borderBoxSize[0];if(h){t({width:h.inlineSize,height:h.blockSize});return}}t(e.getBoundingClientRect())};i.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(o):o()});return n.observe(e,{box:"border-box"}),()=>{n.unobserve(e)}},U={passive:!0},q=typeof window>"u"?!0:"onscrollend"in window,ue=(i,r)=>{const e=i.scrollElement;if(!e)return;const s=i.targetWindow;if(!s)return;let t=0;const n=i.options.useScrollendEvent&&q?()=>{}:re(s,()=>{r(t,!1)},i.options.isScrollingResetDelay),l=c=>()=>{const{horizontal:S,isRtl:v}=i.options;t=S?e.scrollLeft*(v&&-1||1):e.scrollTop,n(),r(t,c)},o=l(!0),a=l(!1);a(),e.addEventListener("scroll",o,U);const h=i.options.useScrollendEvent&&q;return h&&e.addEventListener("scrollend",a,U),()=>{e.removeEventListener("scroll",o),h&&e.removeEventListener("scrollend",a)}},de=(i,r,e)=>{if(r!=null&&r.borderBoxSize){const s=r.borderBoxSize[0];if(s)return Math.round(s[e.options.horizontal?"inlineSize":"blockSize"])}return Math.round(i.getBoundingClientRect()[e.options.horizontal?"width":"height"])},fe=(i,{adjustments:r=0,behavior:e},s)=>{var t,n;const l=i+r;(n=(t=s.scrollElement)==null?void 0:t.scrollTo)==null||n.call(t,{[s.options.horizontal?"left":"top"]:l,behavior:e})};class me{constructor(r){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.scrollToIndexTimeoutId=null,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let e=null;const s=()=>e||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:e=new this.targetWindow.ResizeObserver(t=>{t.forEach(n=>{const l=()=>{this._measureElement(n.target,n)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var t;(t=s())==null||t.disconnect(),e=null},observe:t=>{var n;return(n=s())==null?void 0:n.observe(t,{box:"border-box"})},unobserve:t=>{var n;return(n=s())==null?void 0:n.unobserve(t)}}})(),this.range=null,this.setOptions=e=>{Object.entries(e).forEach(([s,t])=>{typeof t>"u"&&delete e[s]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:ae,rangeExtractor:ce,onChange:()=>{},measureElement:de,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}},this.notify=e=>{var s,t;(t=(s=this.options).onChange)==null||t.call(s,this,e)},this.maybeNotify=C(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var e;const s=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==s){if(this.cleanup(),!s){this.maybeNotify();return}this.scrollElement=s,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((e=this.scrollElement)==null?void 0:e.window)??null,this.elementsCache.forEach(t=>{this.observer.observe(t)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,t=>{this.scrollRect=t,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(t,n)=>{this.scrollAdjustments=0,this.scrollDirection=n?this.getScrollOffset()<t?"forward":"backward":null,this.scrollOffset=t,this.isScrolling=n,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(e,s)=>{const t=new Map,n=new Map;for(let l=s-1;l>=0;l--){const o=e[l];if(t.has(o.lane))continue;const a=n.get(o.lane);if(a==null||o.end>a.end?n.set(o.lane,o):o.end<a.end&&t.set(o.lane,!0),t.size===this.options.lanes)break}return n.size===this.options.lanes?Array.from(n.values()).sort((l,o)=>l.end===o.end?l.index-o.index:l.end-o.end)[0]:void 0},this.getMeasurementOptions=C(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(e,s,t,n,l)=>(this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:s,scrollMargin:t,getItemKey:n,enabled:l}),{key:!1}),this.getMeasurements=C(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:s,scrollMargin:t,getItemKey:n,enabled:l},o)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(c=>{this.itemSizeCache.set(c.key,c.size)}));const a=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const h=this.measurementsCache.slice(0,a);for(let c=a;c<e;c++){const S=n(c),v=this.options.lanes===1?h[c-1]:this.getFurthestMeasurement(h,c),y=v?v.end+this.options.gap:s+t,z=o.get(S),k=typeof z=="number"?z:this.options.estimateSize(c),E=y+k,M=v?v.lane:c%this.options.lanes;h[c]={index:c,start:y,size:k,end:E,key:S,lane:M}}return this.measurementsCache=h,h},{key:!1,debug:()=>this.options.debug}),this.calculateRange=C(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,s,t,n)=>this.range=e.length>0&&s>0?ge({measurements:e,outerSize:s,scrollOffset:t,lanes:n}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=C(()=>{let e=null,s=null;const t=this.calculateRange();return t&&(e=t.startIndex,s=t.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,s]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,s]},(e,s,t,n,l)=>n===null||l===null?[]:e({startIndex:n,endIndex:l,overscan:s,count:t}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=e=>{const s=this.options.indexAttribute,t=e.getAttribute(s);return t?parseInt(t,10):(console.warn(`Missing attribute name '${s}={index}' on measured element.`),-1)},this._measureElement=(e,s)=>{const t=this.indexFromElement(e),n=this.measurementsCache[t];if(!n)return;const l=n.key,o=this.elementsCache.get(l);o!==e&&(o&&this.observer.unobserve(o),this.observer.observe(e),this.elementsCache.set(l,e)),e.isConnected&&this.resizeItem(t,this.options.measureElement(e,s,this))},this.resizeItem=(e,s)=>{const t=this.measurementsCache[e];if(!t)return;const n=this.itemSizeCache.get(t.key)??t.size,l=s-n;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(t,l,this):t.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(t.index),this.itemSizeCache=new Map(this.itemSizeCache.set(t.key,s)),this.notify(!1))},this.measureElement=e=>{if(!e){this.elementsCache.forEach((s,t)=>{s.isConnected||(this.observer.unobserve(s),this.elementsCache.delete(t))});return}this._measureElement(e,void 0)},this.getVirtualItems=C(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,s)=>{const t=[];for(let n=0,l=e.length;n<l;n++){const o=e[n],a=s[o];t.push(a)}return t},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=e=>{const s=this.getMeasurements();if(s.length!==0)return j(s[K(0,s.length-1,t=>j(s[t]).start,e)])},this.getOffsetForAlignment=(e,s,t=0)=>{const n=this.getSize(),l=this.getScrollOffset();s==="auto"&&(s=e>=l+n?"end":"start"),s==="center"?e+=(t-n)/2:s==="end"&&(e-=n);const o=this.options.horizontal?"scrollWidth":"scrollHeight",h=(this.scrollElement?"document"in this.scrollElement?this.scrollElement.document.documentElement[o]:this.scrollElement[o]:0)-n;return Math.max(Math.min(h,e),0)},this.getOffsetForIndex=(e,s="auto")=>{e=Math.max(0,Math.min(e,this.options.count-1));const t=this.measurementsCache[e];if(!t)return;const n=this.getSize(),l=this.getScrollOffset();if(s==="auto")if(t.end>=l+n-this.options.scrollPaddingEnd)s="end";else if(t.start<=l+this.options.scrollPaddingStart)s="start";else return[l,s];const o=s==="end"?t.end+this.options.scrollPaddingEnd:t.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(o,s,t.size),s]},this.isDynamicMode=()=>this.elementsCache.size>0,this.cancelScrollToIndex=()=>{this.scrollToIndexTimeoutId!==null&&this.targetWindow&&(this.targetWindow.clearTimeout(this.scrollToIndexTimeoutId),this.scrollToIndexTimeoutId=null)},this.scrollToOffset=(e,{align:s="start",behavior:t}={})=>{this.cancelScrollToIndex(),t==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(e,s),{adjustments:void 0,behavior:t})},this.scrollToIndex=(e,{align:s="auto",behavior:t}={})=>{e=Math.max(0,Math.min(e,this.options.count-1)),this.cancelScrollToIndex(),t==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size.");const n=this.getOffsetForIndex(e,s);if(!n)return;const[l,o]=n;this._scrollToOffset(l,{adjustments:void 0,behavior:t}),t!=="smooth"&&this.isDynamicMode()&&this.targetWindow&&(this.scrollToIndexTimeoutId=this.targetWindow.setTimeout(()=>{if(this.scrollToIndexTimeoutId=null,this.elementsCache.has(this.options.getItemKey(e))){const[h]=j(this.getOffsetForIndex(e,o));le(h,this.getScrollOffset())||this.scrollToIndex(e,{align:o,behavior:t})}else this.scrollToIndex(e,{align:o,behavior:t})}))},this.scrollBy=(e,{behavior:s}={})=>{this.cancelScrollToIndex(),s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:s})},this.getTotalSize=()=>{var e;const s=this.getMeasurements();let t;if(s.length===0)t=this.options.paddingStart;else if(this.options.lanes===1)t=((e=s[s.length-1])==null?void 0:e.end)??0;else{const n=Array(this.options.lanes).fill(null);let l=s.length-1;for(;l>=0&&n.some(o=>o===null);){const o=s[l];n[o.lane]===null&&(n[o.lane]=o.end),l--}t=Math.max(...n.filter(o=>o!==null))}return Math.max(t-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(e,{adjustments:s,behavior:t})=>{this.options.scrollToFn(e,{behavior:t,adjustments:s},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(r)}}const K=(i,r,e,s)=>{for(;i<=r;){const t=(i+r)/2|0,n=e(t);if(n<s)i=t+1;else if(n>s)r=t-1;else return t}return i>0?i-1:0};function ge({measurements:i,outerSize:r,scrollOffset:e,lanes:s}){const t=i.length-1,n=a=>i[a].start;if(i.length<=s)return{startIndex:0,endIndex:t};let l=K(0,t,n,e),o=l;if(s===1)for(;o<t&&i[o].end<e+r;)o++;else if(s>1){const a=Array(s).fill(0);for(;o<t&&a.some(c=>c<e+r);){const c=i[o];a[c.lane]=c.end,o++}const h=Array(s).fill(e+r);for(;l>=0&&h.some(c=>c>=e);){const c=i[l];h[c.lane]=c.start,l--}l=Math.max(0,l-l%s),o=Math.min(t,o+(s-1-o%s))}return{startIndex:l,endIndex:o}}function ve(i){const r=new me(B(i)),e=G(r),s=r._didMount();return W(()=>B(i).getScrollElement(),t=>{t&&r._willUpdate()},{immediate:!0}),W(()=>B(i),t=>{r.setOptions({...t,onChange:(n,l)=>{var o;V(e),(o=t.onChange)==null||o.call(t,n,l)}}),r._willUpdate(),V(e)},{immediate:!0}),J(s),e}function pe(i){return ve(D(()=>({observeElementRect:he,observeElementOffset:ue,scrollToFn:fe,...B(i)})))}const be="_book_1hts7_1",xe="_mask_1hts7_24",Se="_tools_1hts7_35",ye="_tool_1hts7_35",we="_picked_1hts7_57",ze="_info_1hts7_61",ke="_cover_1hts7_65",_e="_abstract_1hts7_75",Ie="_title_1hts7_91",m={"book-list":"_book-list_1hts7_1","virtual-list":"_virtual-list_1hts7_10",book:be,mask:xe,tools:Se,tool:ye,picked:we,info:ze,cover:ke,abstract:_e,"full-text":"_full-text_1hts7_83",title:Ie};function Ee(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!ee(i)}const Re=Q({name:"BookList",props:{data:{type:Array,default:()=>[]},onPreviewBook:{type:Function},onEditBook:{type:Function},onDeleteBook:{type:Function}},setup(i){const{data:r}=X(i),{t:e}=Y({useScope:"global"}),s=I([]);W(()=>r.value,u=>{te.book.queryCoversById(u.map(f=>f.covers[0]||"")).then(f=>{s.value=f.map((p,g)=>se(p==null?void 0:p.file,u[g].title))})},{immediate:!0});const t=I(),n=I(!1),l=I(),o=()=>{t.value=void 0,n.value=!1,window.clearTimeout(l.value),l.value=void 0,y.value=!1,v.value=[-999,-999]},a=u=>{var g,w;if(u.touches.length!==1||((w=(g=u.target)==null?void 0:g.dataset)==null?void 0:w.target)==="tools")return;(n.value||t.value!==void 0)&&o()},h=()=>{t.value===void 0&&n.value&&o()},c=()=>{h()},S=()=>{h()},v=I([-999,-999]),y=I(!1),z=[{name:"preview",icon:"👀️",cb:()=>{var u;if(t.value!==void 0){const f=r.value[t.value];(u=i.onPreviewBook)==null||u.call(i,f)}o()}},{name:"edit",icon:d($,{name:"pencil"},null),cb:()=>{var u;if(t.value!==void 0){const f=r.value[t.value];(u=i.onEditBook)==null||u.call(i,f)}o()}},{name:"delete",icon:d($,{name:"delete"},null),cb:u=>{const{x:f,y:p}=u;v.value=[f,p],y.value=!0}}],k=u=>{var R,F,b,O;const f=(F=(R=u.target)==null?void 0:R.dataset)==null?void 0:F.tool,p=z.find(A=>A.name===f);if(p){p.cb(u);return}const g=(b=u.target)==null?void 0:b.closest("[data-index]"),w=((O=g==null?void 0:g.dataset)==null?void 0:O.index)||"",T=Number.parseInt(w,10);Number.isNaN(T)||(t.value=T,n.value=!1)},E=I(null),M=D(()=>({count:r.value.length,getScrollElement:()=>E.value,estimateSize:()=>135,overscan:3,gap:16})),_=pe(M),N=D(()=>_.value.getVirtualItems()),H=D(()=>_.value.getTotalSize());return()=>{var f,p;let u;return d(Z,null,[d("div",{class:x(m["book-list"]),ref:E,onTouchstart:a,onTouchmove:h,onTouchend:c,onTouchcancel:S,onClick:k},[d("div",{class:x(m["virtual-list"]),style:{"--list-height":`${H.value}px`}},[N.value.map(g=>{var O,A;const{index:w,key:T,size:R,start:F}=g,b=r.value[w];return d("div",{class:x(m.book),key:String(T),style:{"--book-height":`${R}px`,"--book-start":`${F}px`}},[d("div",{class:x(m.mask,{[m.picked]:t.value===w})},[d("div",{class:x(m.tools)},[z.map(L=>d("div",{class:x(m.tool),"data-target":"tools","data-tool":L.name},[L.icon]))])]),d("div",{class:x(m.info),"data-index":w},[d("div",{class:x(m.cover),style:{backgroundImage:`url(${s.value[w]})`}},null),d("div",{class:x(m.abstract)},[d("div",{class:x(m["full-text"],m.title)},[b.title]),d("div",{class:x(m["full-text"])},[b.authors?(O=b.authors)==null?void 0:O.join(" / "):e("pages.cell.bookList.unknownAuthor")]),d("div",{class:x(m["full-text"])},[b.publishers?(A=b.publishers)==null?void 0:A.join(" / "):e("pages.cell.bookList.unknownPublisher")]),d("div",null,[P("isbn: "),b.isbn]),d("div",null,[e("pages.cell.bookList.progress"),P(": "),ne(b.lastReadPage,b.numberOfPages),P(" %")]),d(ie,{count:5,value:b.rating,readonly:!0,size:"small"},null)])])])})])]),d(oe,{showIcon:!1,placement:"left-end",trigger:"manual",positiveText:e("common.delete"),negativeText:e("common.forgetIt"),"positive-button-props":{type:"error"},onPositiveClick:()=>{var g;if(t.value!==void 0){const w=r.value[t.value];(g=i.onDeleteBook)==null||g.call(i,w)}o()},onNegativeClick:()=>{y.value=!1},onClickoutside:()=>{y.value=!1},x:(f=v.value)==null?void 0:f[0],y:(p=v.value)==null?void 0:p[1],show:y.value},Ee(u=e("common.deleteConfirm"))?u:{default:()=>[u]})])}}});export{Re as B};
//# sourceMappingURL=BookList-d0gCqb-E.js.map
