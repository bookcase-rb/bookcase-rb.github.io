import{L as A,bc as D,s as H,w as P,bd as L,be as G,d as J,t as Q,u as X,r as k,c as d,S as V,e as p,g as Y,F as Z,i as ee,f as te,al as se}from"./index-Bk_Q6iwp.js";import{N as ne}from"./Rate-BCurNBux.js";import{N as ie}from"./Popconfirm-CuFllFqB.js";function T(i,r,t){let s=t.initialDeps??[],e;function n(){var l,o,a,u;let c;t.key&&((l=t.debug)!=null&&l.call(t))&&(c=Date.now());const x=i();if(!(x.length!==s.length||x.some((w,_)=>s[_]!==w)))return e;s=x;let z;if(t.key&&((o=t.debug)!=null&&o.call(t))&&(z=Date.now()),e=r(...x),t.key&&((a=t.debug)!=null&&a.call(t))){const w=Math.round((Date.now()-c)*100)/100,_=Math.round((Date.now()-z)*100)/100,E=_/16,M=(I,B)=>{for(I=String(I);I.length<B;)I=" "+I;return I};console.info(`%câ± ${M(_,5)} /${M(w,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*E,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(u=t==null?void 0:t.onChange)==null||u.call(t,e),e}return n.updateDeps=l=>{s=l},n}function N(i,r){if(i===void 0)throw new Error("Unexpected undefined");return i}const oe=(i,r)=>Math.abs(i-r)<1,le=(i,r,t)=>{let s;return function(...e){i.clearTimeout(s),s=i.setTimeout(()=>r.apply(this,e),t)}},re=i=>i,ae=i=>{const r=Math.max(i.startIndex-i.overscan,0),t=Math.min(i.endIndex+i.overscan,i.count-1),s=[];for(let e=r;e<=t;e++)s.push(e);return s},ce=(i,r)=>{const t=i.scrollElement;if(!t)return;const s=i.targetWindow;if(!s)return;const e=l=>{const{width:o,height:a}=l;r({width:Math.round(o),height:Math.round(a)})};if(e(t.getBoundingClientRect()),!s.ResizeObserver)return()=>{};const n=new s.ResizeObserver(l=>{const o=()=>{const a=l[0];if(a!=null&&a.borderBoxSize){const u=a.borderBoxSize[0];if(u){e({width:u.inlineSize,height:u.blockSize});return}}e(t.getBoundingClientRect())};i.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(o):o()});return n.observe(t,{box:"border-box"}),()=>{n.unobserve(t)}},$={passive:!0},U=typeof window>"u"?!0:"onscrollend"in window,ue=(i,r)=>{const t=i.scrollElement;if(!t)return;const s=i.targetWindow;if(!s)return;let e=0;const n=i.options.useScrollendEvent&&U?()=>{}:le(s,()=>{r(e,!1)},i.options.isScrollingResetDelay),l=c=>()=>{const{horizontal:x,isRtl:g}=i.options;e=x?t.scrollLeft*(g&&-1||1):t.scrollTop,n(),r(e,c)},o=l(!0),a=l(!1);a(),t.addEventListener("scroll",o,$);const u=i.options.useScrollendEvent&&U;return u&&t.addEventListener("scrollend",a,$),()=>{t.removeEventListener("scroll",o),u&&t.removeEventListener("scrollend",a)}},he=(i,r,t)=>{if(r!=null&&r.borderBoxSize){const s=r.borderBoxSize[0];if(s)return Math.round(s[t.options.horizontal?"inlineSize":"blockSize"])}return Math.round(i.getBoundingClientRect()[t.options.horizontal?"width":"height"])},de=(i,{adjustments:r=0,behavior:t},s)=>{var e,n;const l=i+r;(n=(e=s.scrollElement)==null?void 0:e.scrollTo)==null||n.call(e,{[s.options.horizontal?"left":"top"]:l,behavior:t})};class fe{constructor(r){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.scrollToIndexTimeoutId=null,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const s=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(e=>{e.forEach(n=>{const l=()=>{this._measureElement(n.target,n)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var e;(e=s())==null||e.disconnect(),t=null},observe:e=>{var n;return(n=s())==null?void 0:n.observe(e,{box:"border-box"})},unobserve:e=>{var n;return(n=s())==null?void 0:n.unobserve(e)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([s,e])=>{typeof e>"u"&&delete t[s]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:re,rangeExtractor:ae,onChange:()=>{},measureElement:he,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var s,e;(e=(s=this.options).onChange)==null||e.call(s,this,t)},this.maybeNotify=T(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const s=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==s){if(this.cleanup(),!s){this.maybeNotify();return}this.scrollElement=s,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(e=>{this.observer.observe(e)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,e=>{this.scrollRect=e,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(e,n)=>{this.scrollAdjustments=0,this.scrollDirection=n?this.getScrollOffset()<e?"forward":"backward":null,this.scrollOffset=e,this.isScrolling=n,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,s)=>{const e=new Map,n=new Map;for(let l=s-1;l>=0;l--){const o=t[l];if(e.has(o.lane))continue;const a=n.get(o.lane);if(a==null||o.end>a.end?n.set(o.lane,o):o.end<a.end&&e.set(o.lane,!0),e.size===this.options.lanes)break}return n.size===this.options.lanes?Array.from(n.values()).sort((l,o)=>l.end===o.end?l.index-o.index:l.end-o.end)[0]:void 0},this.getMeasurementOptions=T(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,s,e,n,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:s,scrollMargin:e,getItemKey:n,enabled:l}),{key:!1}),this.getMeasurements=T(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:s,scrollMargin:e,getItemKey:n,enabled:l},o)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(c=>{this.itemSizeCache.set(c.key,c.size)}));const a=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const u=this.measurementsCache.slice(0,a);for(let c=a;c<t;c++){const x=n(c),g=this.options.lanes===1?u[c-1]:this.getFurthestMeasurement(u,c),z=g?g.end+this.options.gap:s+e,w=o.get(x),_=typeof w=="number"?w:this.options.estimateSize(c),E=z+_,M=g?g.lane:c%this.options.lanes;u[c]={index:c,start:z,size:_,end:E,key:x,lane:M}}return this.measurementsCache=u,u},{key:!1,debug:()=>this.options.debug}),this.calculateRange=T(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,s,e,n)=>this.range=t.length>0&&s>0?me({measurements:t,outerSize:s,scrollOffset:e,lanes:n}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=T(()=>{let t=null,s=null;const e=this.calculateRange();return e&&(t=e.startIndex,s=e.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,s]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,s]},(t,s,e,n,l)=>n===null||l===null?[]:t({startIndex:n,endIndex:l,overscan:s,count:e}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const s=this.options.indexAttribute,e=t.getAttribute(s);return e?parseInt(e,10):(console.warn(`Missing attribute name '${s}={index}' on measured element.`),-1)},this._measureElement=(t,s)=>{const e=this.indexFromElement(t),n=this.measurementsCache[e];if(!n)return;const l=n.key,o=this.elementsCache.get(l);o!==t&&(o&&this.observer.unobserve(o),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(e,this.options.measureElement(t,s,this))},this.resizeItem=(t,s)=>{const e=this.measurementsCache[t];if(!e)return;const n=this.itemSizeCache.get(e.key)??e.size,l=s-n;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(e,l,this):e.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(e.index),this.itemSizeCache=new Map(this.itemSizeCache.set(e.key,s)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((s,e)=>{s.isConnected||(this.observer.unobserve(s),this.elementsCache.delete(e))});return}this._measureElement(t,void 0)},this.getVirtualItems=T(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,s)=>{const e=[];for(let n=0,l=t.length;n<l;n++){const o=t[n],a=s[o];e.push(a)}return e},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const s=this.getMeasurements();if(s.length!==0)return N(s[q(0,s.length-1,e=>N(s[e]).start,t)])},this.getOffsetForAlignment=(t,s,e=0)=>{const n=this.getSize(),l=this.getScrollOffset();s==="auto"&&(s=t>=l+n?"end":"start"),s==="center"?t+=(e-n)/2:s==="end"&&(t-=n);const o=this.options.horizontal?"scrollWidth":"scrollHeight",u=(this.scrollElement?"document"in this.scrollElement?this.scrollElement.document.documentElement[o]:this.scrollElement[o]:0)-n;return Math.max(Math.min(u,t),0)},this.getOffsetForIndex=(t,s="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const e=this.measurementsCache[t];if(!e)return;const n=this.getSize(),l=this.getScrollOffset();if(s==="auto")if(e.end>=l+n-this.options.scrollPaddingEnd)s="end";else if(e.start<=l+this.options.scrollPaddingStart)s="start";else return[l,s];const o=s==="end"?e.end+this.options.scrollPaddingEnd:e.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(o,s,e.size),s]},this.isDynamicMode=()=>this.elementsCache.size>0,this.cancelScrollToIndex=()=>{this.scrollToIndexTimeoutId!==null&&this.targetWindow&&(this.targetWindow.clearTimeout(this.scrollToIndexTimeoutId),this.scrollToIndexTimeoutId=null)},this.scrollToOffset=(t,{align:s="start",behavior:e}={})=>{this.cancelScrollToIndex(),e==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,s),{adjustments:void 0,behavior:e})},this.scrollToIndex=(t,{align:s="auto",behavior:e}={})=>{t=Math.max(0,Math.min(t,this.options.count-1)),this.cancelScrollToIndex(),e==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size.");const n=this.getOffsetForIndex(t,s);if(!n)return;const[l,o]=n;this._scrollToOffset(l,{adjustments:void 0,behavior:e}),e!=="smooth"&&this.isDynamicMode()&&this.targetWindow&&(this.scrollToIndexTimeoutId=this.targetWindow.setTimeout(()=>{if(this.scrollToIndexTimeoutId=null,this.elementsCache.has(this.options.getItemKey(t))){const[u]=N(this.getOffsetForIndex(t,o));oe(u,this.getScrollOffset())||this.scrollToIndex(t,{align:o,behavior:e})}else this.scrollToIndex(t,{align:o,behavior:e})}))},this.scrollBy=(t,{behavior:s}={})=>{this.cancelScrollToIndex(),s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:s})},this.getTotalSize=()=>{var t;const s=this.getMeasurements();let e;if(s.length===0)e=this.options.paddingStart;else if(this.options.lanes===1)e=((t=s[s.length-1])==null?void 0:t.end)??0;else{const n=Array(this.options.lanes).fill(null);let l=s.length-1;for(;l>=0&&n.some(o=>o===null);){const o=s[l];n[o.lane]===null&&(n[o.lane]=o.end),l--}e=Math.max(...n.filter(o=>o!==null))}return Math.max(e-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:s,behavior:e})=>{this.options.scrollToFn(t,{behavior:e,adjustments:s},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(r)}}const q=(i,r,t,s)=>{for(;i<=r;){const e=(i+r)/2|0,n=t(e);if(n<s)i=e+1;else if(n>s)r=e-1;else return e}return i>0?i-1:0};function me({measurements:i,outerSize:r,scrollOffset:t,lanes:s}){const e=i.length-1,n=a=>i[a].start;if(i.length<=s)return{startIndex:0,endIndex:e};let l=q(0,e,n,t),o=l;if(s===1)for(;o<e&&i[o].end<t+r;)o++;else if(s>1){const a=Array(s).fill(0);for(;o<e&&a.some(c=>c<t+r);){const c=i[o];a[c.lane]=c.end,o++}const u=Array(s).fill(t+r);for(;l>=0&&u.some(c=>c>=t);){const c=i[l];u[c.lane]=c.start,l--}l=Math.max(0,l-l%s),o=Math.min(e,o+(s-1-o%s))}return{startIndex:l,endIndex:o}}function ge(i){const r=new fe(D(i)),t=H(r),s=r._didMount();return P(()=>D(i).getScrollElement(),e=>{e&&r._willUpdate()},{immediate:!0}),P(()=>D(i),e=>{r.setOptions({...e,onChange:(n,l)=>{var o;L(t),(o=e.onChange)==null||o.call(e,n,l)}}),r._willUpdate(),L(t)},{immediate:!0}),G(s),t}function ve(i){return ge(A(()=>({observeElementRect:ce,observeElementOffset:ue,scrollToFn:de,...D(i)})))}const be="_book_7ibaz_1",pe="_mask_7ibaz_24",xe="_tools_7ibaz_36",ze="_tool_7ibaz_36",Se="_picked_7ibaz_58",ye="_info_7ibaz_65",we="_cover_7ibaz_69",_e="_abstract_7ibaz_79",Ie="_title_7ibaz_95",m={"book-list":"_book-list_7ibaz_1","virtual-list":"_virtual-list_7ibaz_10",book:be,mask:pe,tools:xe,tool:ze,picked:Se,info:ye,cover:we,abstract:_e,"full-text":"_full-text_7ibaz_87",title:Ie};function ke(i){return typeof i=="function"||Object.prototype.toString.call(i)==="[object Object]"&&!ee(i)}const Ce=J({name:"BookList",props:{data:{type:Array,default:()=>[]},onPreviewBook:{type:Function},onEditBook:{type:Function},onDeleteBook:{type:Function}},setup(i){const{data:r}=Q(i),{t}=X({useScope:"global"}),s=k([]);P(()=>r.value,h=>{te.book.queryCoversById(h.map(f=>f.covers[0]||"")).then(f=>{s.value=f.map((v,S)=>se(v==null?void 0:v.file,h[S].title))})},{immediate:!0});const e=k(),n=k(!1),l=k(),o=()=>{e.value=void 0,n.value=!1,window.clearTimeout(l.value),l.value=void 0,z.value=!1,g.value=[-999,-999]},a=h=>{var S,b;if(h.touches.length!==1||((b=(S=h.target)==null?void 0:S.dataset)==null?void 0:b.target)==="tools")return;(n.value||e.value!==void 0)&&o()},u=()=>{e.value===void 0&&n.value&&o()},c=()=>{u()},x=()=>{u()},g=k([-999,-999]),z=k(!1),w=[{name:"preview",icon:"ðŸ‘€ï¸",cb:()=>{var h;if(e.value!==void 0){const f=r.value[e.value];(h=i.onPreviewBook)==null||h.call(i,f)}o()}},{name:"edit",icon:d(V,{name:"pencil"},null),cb:()=>{var h;if(e.value!==void 0){const f=r.value[e.value];(h=i.onEditBook)==null||h.call(i,f)}o()}},{name:"delete",icon:d(V,{name:"delete"},null),cb:h=>{const{x:f,y:v}=h;g.value=[f,v],z.value=!0}}],_=h=>{var C,O,R,y;const f=(O=(C=h.target)==null?void 0:C.dataset)==null?void 0:O.tool,v=w.find(F=>F.name===f);if(v){v.cb(h);return}const S=((y=(R=h.target)==null?void 0:R.dataset)==null?void 0:y.index)||"",b=Number.parseInt(S,10);Number.isNaN(b)||(e.value=b,n.value=!1)},E=k(null),M=A(()=>({count:r.value.length,getScrollElement:()=>E.value,estimateSize:()=>120,overscan:3,gap:16})),I=ve(M),B=A(()=>I.value.getVirtualItems()),K=A(()=>I.value.getTotalSize());return()=>{var f,v;let h;return d(Z,null,[d("div",{class:p(m["book-list"]),ref:E,onTouchstart:a,onTouchmove:u,onTouchend:c,onTouchcancel:x,onClick:_},[d("div",{class:p(m["virtual-list"]),style:{"--list-height":`${K.value}px`}},[B.value.map(S=>{var F,W;const{index:b,key:C,size:O,start:R}=S,y=r.value[b];return d("div",{class:p(m.book),key:String(C),style:{"--book-height":`${O}px`,"--book-start":`${R}px`}},[d("div",{class:p(m.mask,{[m.picked]:e.value===b}),"data-index":b},[d("div",{class:p(m.tools)},[w.map(j=>d("div",{class:p(m.tool),"data-target":"tools","data-tool":j.name},[j.icon]))])]),d("div",{class:p(m.info)},[d("div",{class:p(m.cover),style:{backgroundImage:`url(${s.value[b]})`}},null),d("div",{class:p(m.abstract)},[d("div",{class:p(m["full-text"],m.title)},[y.title]),d("div",{class:p(m["full-text"])},[y.authors?(F=y.authors)==null?void 0:F.join(" / "):t("pages.cell.bookList.unknownAuthor")]),d("div",{class:p(m["full-text"])},[y.publishers?(W=y.publishers)==null?void 0:W.join(" / "):t("pages.cell.bookList.unknownPublisher")]),d("div",null,[Y("isbn: "),y.isbn]),d(ne,{count:5,value:y.rating,readonly:!0,size:"small"},null)])])])})])]),d(ie,{showIcon:!1,placement:"left-end",trigger:"manual",positiveText:t("common.delete"),negativeText:t("common.forgetIt"),"positive-button-props":{type:"error"},onPositiveClick:()=>{var S;if(e.value!==void 0){const b=r.value[e.value];(S=i.onDeleteBook)==null||S.call(i,b)}o()},onNegativeClick:()=>{z.value=!1},onClickoutside:()=>{z.value=!1},x:(f=g.value)==null?void 0:f[0],y:(v=g.value)==null?void 0:v[1],show:z.value},ke(h=t("common.deleteConfirm"))?h:{default:()=>[h]})])}}});export{Ce as B};
//# sourceMappingURL=BookList-q6khKxTM.js.map
