import{u as R}from"./useTRouter-DP--qWrD.js";import{d as M,u as V,a as O,s as L,r as C,w as P,b as U,c as t,e as f,B as p,S as v,i as $,f as c,I as F,F as G}from"./index-DG1BSOqx.js";import{B as H,E as J}from"./BookcaseNameInput-242W81VN.js";import{B as K,a as Q}from"./BasicTopBar-DuZzNMww.js";import{D as W}from"./DeleteConfirmButton-BsD9Nj1m.js";import"./utils-CAYNC9ZV.js";import"./Popconfirm-C716FB8M.js";import"./Popover-pV-BjsIs.js";import"./get-C1tFBBB5.js";const X="_title_1ryey_6",Y="_blur_1ryey_13",d={"edit-bookcase":"_edit-bookcase_1ryey_1",title:X,blur:Y};function j(o){return typeof o=="function"||Object.prototype.toString.call(o)==="[object Object]"&&!$(o)}const re=M({name:"BookcaseEdit",setup(){const{t:o}=V({useScope:"global"}),{route:w,router:y}=R(),{dialog:S,message:n}=O("top"),b=L(),g=C(""),r=C(!1);P(()=>w.params,e=>{const a=e.id;a&&(r.value=!0,c.bookcase.queryBookcaseById(a).then(l=>{b.value=l,g.value=(l==null?void 0:l.name)||""}).finally(()=>{r.value=!1}))},{immediate:!0});const s=C(),i=C(!1),T=()=>{var a;const e=(a=s.value)==null?void 0:a.getActiveCells();c.book.queryBooksCountByCellIds(e.map(l=>l.id||"")).then(l=>{var u;l===0?(i.value=!0,(u=s.value)==null||u.mergeCells().catch(()=>{i.value=!1,n.error("merge failed")})):S.warning({closable:!1,maskClosable:!1,title:o("pages.bookcase.edit.mergeDialog.title"),content:()=>t(G,null,[t(F,{scope:"global",keypath:"pages.bookcase.edit.mergeDialog.content.count",tag:"div"},j(l)?l:{default:()=>[l]}),t(F,{scope:"global",keypath:"pages.bookcase.edit.mergeDialog.content.tip",tag:"div"},null)]),positiveText:o("pages.bookcase.edit.mergeDialog.positiveText"),negativeText:o("common.forgetIt"),onPositiveClick(){var m;(m=s.value)==null||m.mergeCells().then(k=>{var B;(B=s.value)==null||B.getData().then(D=>{const z=D.bookcase,A=D.thumbnailFile;c.bookcase.updateBookcase({...z,name:g.value},A).then(_=>{const I=_.cells.find(h=>h.from.join(",")===k.from.join(",")&&h.to.join(",")===k.to.join(","));I&&c.book.moveBooksToNewCell(e.map(h=>h.id||""),I.id||"").then(()=>{n.success(o("pages.bookcase.edit.mergeDialog.mergeFinished"))}).finally(()=>{b.value=_,i.value=!1})})})}).catch(()=>{i.value=!1,n.error("merge failed")})}})})},N=()=>{var a,l;const e=(a=s.value)==null?void 0:a.getActiveCells();if(e.length===1){const u=e[0].id;u?c.book.queryBooksByCellId(u).then(m=>{var k;m.length>0?n.error(o("pages.bookcase.edit.break.cannotBreak")):(i.value=!0,(k=s.value)==null||k.breakCell())}):(i.value=!0,(l=s.value)==null||l.breakCell())}},E=()=>{var a;const e=(a=s.value)==null?void 0:a.getActiveCells();if(e.length===0){n.warning(o("pages.bookcase.edit.manageCell.noCell"));return}if(e.length>1){n.warning(o("pages.bookcase.edit.manageCell.tooManyCells"));return}if(!e[0].id||i.value){n.warning(o("pages.bookcase.edit.manageCell.unsave"));return}y.push({path:`/cell/${e[0].id}`})},q=()=>{var a;const e=(a=b.value)==null?void 0:a.id;e&&(r.value=!0,c.bookcase.deleteBookcase(e).then(()=>{y.back()}).then(()=>{r.value=!1}))},x=()=>{var e;if(!g.value){n.error(o("pages.bookcase.edit.save.titleRequired"));return}r.value=!0,(e=s.value)==null||e.getData().then(a=>{const l=a.bookcase,u=a.thumbnailFile;c.bookcase.updateBookcase({...l,name:g.value},u).then(m=>{b.value=m,n.success(o("pages.bookcase.edit.save.success"))}).then(()=>{r.value=!1,i.value=!1})})};return U(()=>{n.destroyAll()}),()=>{let e;return t(Q,{loading:r.value,topBar:t(K,{rightSlots:[t(p,{onClick:x},{default:()=>[t(v,{name:"save"},null)]}),t(W,{onConfirm:q},{default:()=>[t(v,{name:"delete"},null)]})]},j(e=o("pages.bookcase.edit.topbar.title"))?e:{default:()=>[e]}),toolBar:[t(p,{class:f(d.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:()=>{var a;(a=s.value)==null||a.resetView()}},{default:()=>[t(v,{name:"restore"},null)]}),t(p,{class:f(d.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:T},{default:()=>[t(v,{name:"mergeCells"},null)]}),t(p,{class:f(d.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:N},{default:()=>[t(v,{name:"breakCells"},null)]}),t(p,{class:f(d.blur),size:"large",circle:!0,strong:!0,tertiary:!0,onClick:E},{default:()=>[t(v,{name:"openCase"},null)]})]},{default:()=>[t("div",{class:f(d["edit-bookcase"])},[t("div",{class:f(d.title,d.blur)},[t(H,{isDual:"dual",value:g.value,onChange:a=>{g.value=a}},null)]),t(J,{ref:s,data:b.value},null)])]})}}});export{re as default};
//# sourceMappingURL=EditBookcase-BH-gx__1.js.map
