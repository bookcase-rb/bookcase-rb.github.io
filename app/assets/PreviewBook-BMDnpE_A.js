import{x as oe,y as le,E as ae,Z as se,G as F,d as B,a5 as ne,J as K,r as k,L as C,a6 as ie,v as L,P as re,t as S,u as N,c as e,e as P,b as y,F as W,I as ce,a7 as ue,w as q,a as $,B as R,S as de,i as pe}from"./index-BJum0OjS.js";import{u as G}from"./useTRouter-B9TBCafN.js";import{l as I,N as ve,g as J}from"./utils-yupanRBl.js";import{t as fe,N as me,a as ge}from"./Image-BzlTeZNT.js";import{a as be,B as z}from"./BasicTopBar-B1c4uNqf.js";import{D as ke,a as he}from"./DeckerLayout-KOSeSre9.js";import{K as D,r as ye}from"./constants-CYYimZnf.js";import"./Popover-CTTm47h6.js";import"./get-aJejw662.js";const we=oe({name:"Ellipsis",common:le,peers:{Tooltip:fe}}),_e=ae("ellipsis",{overflow:"hidden"},[se("line-clamp",`
 white-space: nowrap;
 display: inline-block;
 vertical-align: bottom;
 max-width: 100%;
 `),F("line-clamp",`
 display: -webkit-inline-box;
 -webkit-box-orient: vertical;
 `),F("cursor-pointer",`
 cursor: pointer;
 `)]);function A(t){return`${t}-ellipsis--line-clamp`}function M(t,l){return`${t}-ellipsis--cursor-${l}`}const Be=Object.assign(Object.assign({},K.props),{expandTrigger:String,lineClamp:[Number,String],tooltip:{type:[Boolean,Object],default:!0}}),xe=B({name:"Ellipsis",inheritAttrs:!1,props:Be,slots:Object,setup(t,{slots:l,attrs:d}){const s=ne(),c=K("Ellipsis","-ellipsis",_e,we,t,s),b=k(null),p=k(null),v=k(null),n=k(!1),o=C(()=>{const{lineClamp:a}=t,{value:f}=n;return a!==void 0?{textOverflow:"","-webkit-line-clamp":f?"":a}:{textOverflow:f?"":"ellipsis","-webkit-line-clamp":""}});function i(){let a=!1;const{value:f}=n;if(f)return!0;const{value:g}=b;if(g){const{lineClamp:h}=t;if(m(g),h!==void 0)a=g.scrollHeight<=g.offsetHeight;else{const{value:w}=p;w&&(a=w.getBoundingClientRect().width<=g.getBoundingClientRect().width)}T(g,a)}return a}const r=C(()=>t.expandTrigger==="click"?()=>{var a;const{value:f}=n;f&&((a=v.value)===null||a===void 0||a.setShow(!1)),n.value=!f}:void 0);ie(()=>{var a;t.tooltip&&((a=v.value)===null||a===void 0||a.setShow(!1))});const u=()=>L("span",Object.assign({},re(d,{class:[`${s.value}-ellipsis`,t.lineClamp!==void 0?A(s.value):void 0,t.expandTrigger==="click"?M(s.value,"pointer"):void 0],style:o.value}),{ref:"triggerRef",onClick:r.value,onMouseenter:t.expandTrigger==="click"?i:void 0}),t.lineClamp?l:L("span",{ref:"triggerInnerRef"},l));function m(a){if(!a)return;const f=o.value,g=A(s.value);t.lineClamp!==void 0?x(a,g,"add"):x(a,g,"remove");for(const h in f)a.style[h]!==f[h]&&(a.style[h]=f[h])}function T(a,f){const g=M(s.value,"pointer");t.expandTrigger==="click"&&!f?x(a,g,"add"):x(a,g,"remove")}function x(a,f,g){g==="add"?a.classList.contains(f)||a.classList.add(f):a.classList.contains(f)&&a.classList.remove(f)}return{mergedTheme:c,triggerRef:b,triggerInnerRef:p,tooltipRef:v,handleClick:r,renderTrigger:u,getTooltipDisabled:i}},render(){var t;const{tooltip:l,renderTrigger:d,$slots:s}=this;if(l){const{mergedTheme:c}=this;return L(me,Object.assign({ref:"tooltipRef",placement:"top"},l,{getDisabled:this.getTooltipDisabled,theme:c.peers.Tooltip,themeOverrides:c.peerOverrides.Tooltip}),{trigger:d,default:(t=s.tooltip)!==null&&t!==void 0?t:s.default})}else return d()}}),O=B({name:"Text",props:{text:{type:[String,Number],default:""},placeholder:{type:String,default:"-"}},setup(t){const{text:l,placeholder:d}=S(t),s=()=>{const c=String(l.value);return c||d.value};return()=>s()}}),Ie="_item_1fqoq_1",_={"book-details":"_book-details_1fqoq_1",item:Ie,"book-cover-image":"_book-cover-image_1fqoq_10"},Ce=B({name:"BookDetails",props:{bookData:{type:Object,default:()=>({})},onRateChange:{type:Function}},setup(t){const{bookData:l}=S(t),{t:d}=N({useScope:"global"}),s=C(()=>{var b,p,v;const c=(p=(b=l.value)==null?void 0:b.covers)==null?void 0:p[0];return J(c,(v=l.value)==null?void 0:v.title)});return()=>{var c,b,p,v,n,o,i,r,u;return e("div",{class:y(_["book-details"])},[e("h1",null,[(c=l.value)==null?void 0:c.title]),e("p",null,[(b=l.value)==null?void 0:b.isbn]),e("p",null,[d("pages.book.preview.detail.author"),P("："),I((p=l.value)==null?void 0:p.authors,d("pages.book.preview.detail.noAuthor"),_.item)]),e("p",null,[e(ve,{value:(v=l.value)==null?void 0:v.rating,allowHalf:!0,onUpdateValue:t.onRateChange,readonly:!0},null)]),e("p",null,[e(ge,{class:y(_["book-cover-image"]),src:s.value,renderToolbar:({nodes:m})=>e(W,null,[m.zoomIn,m.resizeToOriginalSize,m.zoomOut])},null)]),e("h3",null,[d("pages.book.preview.detail.details")]),e("p",null,[I((n=l.value)==null?void 0:n.publishers,d("pages.book.preview.detail.noPublisher"),_.item)]),e("p",null,[P("出版时间： "),e(O,{text:(o=l.value)==null?void 0:o.publishDate},null)]),e("p",null,[I((i=l.value)==null?void 0:i.languages,d("pages.book.preview.detail.noLanguage"),_.item)]),e("p",null,[e(ce,{scope:"global",keypath:"pages.book.preview.detail.numberOfPages"},{default:()=>{var m;return[e(O,{text:(m=l.value)==null?void 0:m.numberOfPages,placeholder:"未知"},null)]}})]),e("p",null,[I((r=l.value)==null?void 0:r.tags,d("pages.book.preview.detail.noTags"),_.item)]),e("p",null,[I((u=l.value)==null?void 0:u.subjects,d("pages.book.preview.detail.noSubject"),_.item)]),e("p",null,[e("h3",null,[d("pages.book.preview.detail.summary")]),e("div",null,[e(xe,{expandTrigger:"click",lineClamp:5,tooltip:!1},{default:()=>{var m;return[e(O,{text:(m=l.value)==null?void 0:m.summary},null)]}})])])])}}}),Se="_flip_1j32v_23",U={"duplicate-books-icon":"_duplicate-books-icon_1j32v_1",flip:Se},Te=B({name:"DuplicateBooksIcon",props:{cover:{type:Blob},title:{type:String}},setup(t){const{cover:l,title:d}=S(t),s=C(()=>J(l.value,d.value)),c=k(!1);return setTimeout(()=>{ue(()=>{c.value=!0})},1e3),()=>e("div",{class:y(U["duplicate-books-icon"],{[U.flip]:c.value}),style:{"--background-image":`url(${s.value})`}},["⬜️"])}}),j={"bookcase-preview-container":"_bookcase-preview-container_1pkbt_1","bookcase-preview":"_bookcase-preview_1pkbt_1","bookcase-preview-image":"_bookcase-preview-image_1pkbt_15"},Le=B({name:"BookcasePreview",props:{bookcaseId:{type:String,required:!1},selectedCellId:{type:String,required:!1},isLocated:{type:Boolean,default:!1},onSizeLoad:{type:Function,required:!1}},setup(t){const{bookcaseId:l,selectedCellId:d,isLocated:s}=S(t),{t:c}=N({useScope:"global"}),b=k();q(()=>l.value,o=>{o&&$.bookcase.queryBookcaseById(o).then(i=>{i&&(v(i),b.value=i.name)})},{immediate:!0});const p=k();function v(o){const{meta:i,cells:r}=o,{unit:u,fill:m,fillSelected:T}=i,x=(i.width*u||300)+4,a=(i.height*u||300)+4,f=new D.Stage({container:document.createElement("div"),x:2,y:2,width:x,height:a,draggable:!1}),g=new D.Layer;f.add(g),r.forEach(h=>{const{from:w,to:E,id:Y}=h,Z=w[0]*u,Q=w[1]*u,X=(E[1]-w[1])*u,ee=(E[0]-w[0])*u,te=new D.Rect({y:Q,x:Z,width:ee,height:X,fill:Y===d.value?T:m,cell:{...h},...ye});g.add(te),g.draw()}),f.toBlob({}).then(h=>{p.value=h})}const n=o=>{var u,m;const r=(u=o.target.parentElement)==null?void 0:u.parentElement;(m=t.onSizeLoad)==null||m.call(t,r.clientWidth,r.clientHeight)};return()=>e("div",{class:y(j["bookcase-preview-container"])},[e("div",{class:y(j["bookcase-preview"])},[e("img",{class:y(j["bookcase-preview-image"]),src:p.value&&URL.createObjectURL(p.value),alt:b.value,onLoad:n},null),e("div",null,[e("span",null,[b.value]),e("span",null,[s.value?c("pages.bookcase.preview.current"):""])])])])}}),V={"book-location":"_book-location_1s333_1","preview-card":"_preview-card_1s333_7"},Re=B({name:"BookLocation",props:{bookcaseIds:{type:Array,default:()=>[]}},setup(t){const{router:l}=G(),d=k([]),s=k(!1),c=k([]),b=k(0);return q(d.value,p=>{if(p.filter(v=>v!==void 0).length===t.bookcaseIds.length){s.value=!0;const v=[],n=[0,0];for(let o=0;o<p.length;o++)n[0]<=n[1]?(v.push([0,n[0]]),n[0]+=p[o]):(v.push([1,n[1]]),n[1]+=p[o]);c.value=v,b.value=Math.max(...n)}}),()=>e("div",{class:y(V["book-location"]),style:{height:`${b.value}px`}},[t.bookcaseIds.map((p,v)=>{const n=c.value[v]||[0,0],o=n[0]===0?"0%":"100%",i=n[1]+"px";return e("div",{class:y(V["preview-card"]),style:{visibility:s.value?"visible":"hidden",transform:`translate(${o}, ${i})`},onClick:()=>{l.push(`/cell/${p.cellId}`)}},[e(Le,{key:p.bookcaseId,bookcaseId:p.bookcaseId,selectedCellId:p.cellId,onSizeLoad:(r,u)=>{d.value[v]=u},isLocated:v===0},null)])})])}}),De={"preview-book":"_preview-book_ozp5a_1"};function H(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!pe(t)}const Ae=B({name:"PreviewBook",setup(){const{t}=N({useScope:"global"}),{route:l,router:d}=G(),s=k(),c=k([]);q(()=>l.params,n=>{const{isbn:o,id:i}=n;i?$.book.queryRelatedBooksByBookId(i).then(r=>{if(r!=null&&r.length){const[u,...m]=r;s.value=u,c.value=m||[]}}):o&&$.book.queryFirstBookByIsbn(o).then(r=>{if(r!=null&&r.length){const[u,...m]=r;s.value=u,c.value=m||[]}})},{immediate:!0});function b(){var o;const n=(o=s.value)==null?void 0:o.id;n&&d.push({path:`/book/edit/id/${n}`,replace:!0})}const p=n=>e("div",{class:y(De["preview-book"])},[e(be,{topBar:e(z,{rightSlots:[c.value.length?e(R,{onClick:n},{default:()=>{var o,i,r;return[e(Te,{cover:(i=(o=s.value)==null?void 0:o.covers)==null?void 0:i[0],title:(r=s.value)==null?void 0:r.title},null)]}}):e(W,null,null),e(R,{onClick:b},{default:()=>[e(de,{name:"pencil"},null)]})]},{default:()=>{var o;return[((o=s.value)==null?void 0:o.title)||"-"]}})},{default:()=>[e(Ce,{bookData:s.value},null)]})]),v=n=>{let o,i;const r=[s.value,...c.value].filter(u=>!!u).map(u=>({bookcaseId:u.bookcaseId,cellId:u.cellId}));return e(he,{topBar:e(z,{leftSlots:[e(R,{text:!0,onClick:n},H(o=t("common.close"))?o:{default:()=>[o]})]},H(i=t("pages.book.preview.decker.topbar.title"))?i:{default:()=>[i]})},{default:()=>[e(Re,{bookcaseIds:r},null)]})};return()=>e(ke,null,{default:p,decker:v})}});export{Ae as default};
