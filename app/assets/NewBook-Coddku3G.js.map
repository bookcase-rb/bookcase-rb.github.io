{"version":3,"file":"NewBook-Coddku3G.js","sources":["../../src/pages/book/new/NewBook.tsx"],"sourcesContent":["/**\n * @file 新增图书\n * @author Yangholmes 2025-02-11\n */\n\nimport { defineComponent, onUnmounted, ref, watch } from 'vue';\nimport { useRoute, useRouter } from 'vue-router';\nimport { useI18n } from 'vue-i18n';\nimport cn from 'classnames';\n\nimport { useNaiveFeedback } from '@/composite/useNaiveFeedback';\n\nimport BookForm, { PartOfBook } from '../bookForm/BookForm';\nimport BasicLayout from '@/pages/layout/BasicLayout';\nimport BasicTopBar from '@/pages/layout/BasicTopBar';\nimport SvgIcon from '@/components/svgIcon/SvgIcon';\n\nimport { NButton } from 'naive-ui';\n\nimport { scrapeByIsbn } from '@/services/http';\nimport { Book, scrapeErrorMessage } from '../utils';\n\nimport db from '@/services/db';\n\nimport styles from './newBook.module.less';\n\nexport default defineComponent({\n  name: 'NewBook',\n  setup() {\n    const { t } = useI18n({ useScope: 'global' });\n    const route = useRoute();\n    const router = useRouter();\n    const { message } = useNaiveFeedback();\n\n    const bookFormRef = ref<typeof BookForm>();\n    const bookData = ref<PartOfBook>();\n\n    function onSave() {\n      const { cellId, bookcaseId } = route.query;\n      bookFormRef.value?.getFormData().then((res: Book) => {\n        console.log(res);\n        const bookFormData = res;\n        if (!bookFormData) {\n          // TODO throw error\n          return;\n        }\n        if (typeof cellId !== 'string' || typeof bookcaseId !== 'string') {\n          // TODO throw error\n          throw new Error('cellId and bookcaseId invalid');\n        }\n        db.book.addBook(bookFormData, cellId, bookcaseId).then(res => {\n          const { id } = res;\n          // 跳转到预览页面\n          router.replace({\n            path: `/book/preview/id/${id}`\n          });\n        });\n      });\n    }\n\n    const loading = ref(false);\n    function scrape(isbn: string) {\n      loading.value = true;\n      return scrapeByIsbn(isbn).catch((err) => {\n        message.error(...scrapeErrorMessage(isbn));\n        throw err;\n      }).finally(() => {\n        loading.value = false;\n      });\n    }\n\n    watch(() => route.query, (query) => {\n      const isbn = query.isbn as string;\n\n      isbn && scrape(isbn).then(res => {\n        bookData.value = {\n          ...res,\n        };\n      }).catch(() => {\n        bookData.value = {\n          isbn\n        };\n      });\n    }, {\n      immediate: true\n    });\n\n    onUnmounted(() => {\n      message.destroyAll();\n    });\n\n    return () => (\n      <div class={cn(styles['new-book'])}>\n        <BasicLayout topBar={\n          (<BasicTopBar\n            rightSlots={[\n              <NButton onClick={onSave}>\n                <SvgIcon name=\"save\" />\n              </NButton>\n            ]}>\n            {t('pages.book.new.topbar.title')}\n          </BasicTopBar>)}>\n          <BookForm\n            ref={bookFormRef}\n            scraping={loading.value}\n            data={bookData.value}\n            onScrape={scrape}\n          />\n        </BasicLayout>\n      </div>\n    );\n  }\n});\n\n"],"names":["_isSlot","s","Object","prototype","toString","call","_isVNode","defineComponent","name","setup","t","useI18n","useScope","route","useRoute","router","useRouter","message","useNaiveFeedback","bookFormRef","ref","bookData","onSave","cellId","bookcaseId","query","value","getFormData","then","res","console","log","bookFormData","Error","db","book","addBook","id","replace","path","loading","scrape","isbn","scrapeByIsbn","catch","err","error","scrapeErrorMessage","finally","watch","immediate","onUnmounted","destroyAll","_slot","_createVNode","cn","styles","BasicLayout","BasicTopBar","NButton","default","SvgIcon","BookForm"],"mappings":"8kBAwB2C,SAAAA,EAAAC,EAAA,CAAA,OAAA,OAAAA,GAAA,YAAAC,OAAAC,UAAAC,SAAAC,KAAAJ,CAAA,IAAAK,mBAAAA,CAAAA,EAAAL,CAAA,CAAA,CAE3C,MAAeM,IAAgB,CAC7BC,KAAM,UACNC,OAAQ,CACN,KAAM,CAAEC,EAAAA,CAAG,EAAGC,EAAQ,CAAEC,SAAU,QAAS,CAAC,EACtCC,EAAQC,IACRC,EAASC,IACT,CAAEC,QAAAA,CAAS,EAAGC,EAAgB,EAE9BC,EAAcC,IACdC,EAAWD,IAEjB,SAASE,GAAS,OAChB,KAAM,CAAEC,OAAAA,EAAQC,WAAAA,GAAeX,EAAMY,OACrCN,EAAAA,EAAYO,QAAZP,MAAAA,EAAmBQ,cAAcC,KAAMC,GAAc,CACnDC,QAAQC,IAAIF,CAAG,EACf,MAAMG,EAAeH,EACrB,GAAKG,EAIL,IAAI,OAAOT,GAAW,UAAY,OAAOC,GAAe,SAEtD,MAAM,IAAIS,MAAM,+BAA+B,EAEjDC,EAAGC,KAAKC,QAAQJ,EAAcT,EAAQC,CAAU,EAAEI,KAAKC,GAAO,CAC5D,KAAM,CAAEQ,GAAAA,CAAI,EAAGR,EAEfd,EAAOuB,QAAQ,CACbC,KAAM,oBAAoBF,CAAE,EAC9B,CAAC,CACH,CAAC,EACH,EACF,CAEA,MAAMG,EAAUpB,EAAI,EAAK,EACzB,SAASqB,EAAOC,EAAc,CAC5BF,OAAAA,EAAQd,MAAQ,GACTiB,EAAaD,CAAI,EAAEE,MAAOC,GAAQ,CACvC5B,MAAAA,EAAQ6B,MAAM,GAAGC,EAAmBL,CAAI,CAAC,EACnCG,CACR,CAAC,EAAEG,QAAQ,IAAM,CACfR,EAAQd,MAAQ,EAClB,CAAC,CACH,CAEAuB,OAAAA,EAAM,IAAMpC,EAAMY,MAAQA,GAAU,CAClC,MAAMiB,EAAOjB,EAAMiB,KAEnBA,GAAQD,EAAOC,CAAI,EAAEd,KAAKC,GAAO,CAC/BR,EAASK,MAAQ,CACf,GAAGG,EAEP,CAAC,EAAEe,MAAM,IAAM,CACbvB,EAASK,MAAQ,CACfgB,KAAAA,EAEJ,CAAC,CACH,EAAG,CACDQ,UAAW,EACb,CAAC,EAEDC,EAAY,IAAM,CAChBlC,EAAQmC,WAAU,CACpB,CAAC,EAEM,IAAA,CAAA,IAAAC,EAAA,OAAAC,EAAA,MAAA,CAAA,MACOC,EAAGC,EAAO,UAAU,CAAC,GAACF,CAAAA,EAAAG,EAAA,CAAA,OAAAH,EAAAI,EAAA,CAAA,WAGhB,CAAAJ,EAAAK,EAAA,CAAA,QACQrC,CAAM,EAAA,CAAAsC,QAAAA,IAAAN,CAAAA,EAAAO,EAAA,CAAA,KAAA,MAAA,EAAA,IAAA,CAAA,CAAA,CAAA,CAAA,GAGzB7D,EAAAqD,EACA3C,EAAE,6BAA6B,CAAC,EAAA2C,EAAA,CAAAO,QAAAA,IAAA,CAAAP,CAAA,CAAA,CAAA,CAAA,EAAA,CAAAO,QAAAA,IAAAN,CAAAA,EAAAQ,EAAA,CAAA,IAG5B3C,EAAW,SACNqB,EAAQd,MAAK,KACjBL,EAASK,MAAK,SACVe,CAAM,EAAA,IAAA,CAAA,CAAA,CAAA,CAAA,CAAA,EAK1B,CACF,CAAC"}