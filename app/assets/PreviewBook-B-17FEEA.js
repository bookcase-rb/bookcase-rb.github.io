import{x as oe,y as le,E as ae,Z as se,G as F,d as B,a5 as ne,J as K,r as k,L as C,a6 as ie,v as L,P as re,t as S,u as N,c as e,e as E,b as y,F as W,I as ce,a7 as ue,w as P,a as $,B as R,S as de,i as pe}from"./index-DhaXtIy0.js";import{u as G}from"./useTRouter-BuFIPyyD.js";import{l as I,N as ve,g as J}from"./utils-DS8uTo8M.js";import{t as fe,N as ge,a as me}from"./Image-BoZtHotb.js";import{a as be,B as z}from"./BasicTopBar-BLRqXlhH.js";import{D as ke,a as he}from"./DeckerLayout-DzE9A4ps.js";import{K as D,r as ye}from"./constants-BLjLxGVl.js";import"./Popover-DJSVc_nM.js";import"./get-BqkgVoIx.js";const we=oe({name:"Ellipsis",common:le,peers:{Tooltip:fe}}),_e=ae("ellipsis",{overflow:"hidden"},[se("line-clamp",`
 white-space: nowrap;
 display: inline-block;
 vertical-align: bottom;
 max-width: 100%;
 `),F("line-clamp",`
 display: -webkit-inline-box;
 -webkit-box-orient: vertical;
 `),F("cursor-pointer",`
 cursor: pointer;
 `)]);function A(t){return`${t}-ellipsis--line-clamp`}function M(t,l){return`${t}-ellipsis--cursor-${l}`}const Be=Object.assign(Object.assign({},K.props),{expandTrigger:String,lineClamp:[Number,String],tooltip:{type:[Boolean,Object],default:!0}}),xe=B({name:"Ellipsis",inheritAttrs:!1,props:Be,slots:Object,setup(t,{slots:l,attrs:c}){const s=ne(),u=K("Ellipsis","-ellipsis",_e,we,t,s),b=k(null),p=k(null),v=k(null),n=k(!1),o=C(()=>{const{lineClamp:a}=t,{value:f}=n;return a!==void 0?{textOverflow:"","-webkit-line-clamp":f?"":a}:{textOverflow:f?"":"ellipsis","-webkit-line-clamp":""}});function i(){let a=!1;const{value:f}=n;if(f)return!0;const{value:m}=b;if(m){const{lineClamp:h}=t;if(g(m),h!==void 0)a=m.scrollHeight<=m.offsetHeight;else{const{value:w}=p;w&&(a=w.getBoundingClientRect().width<=m.getBoundingClientRect().width)}T(m,a)}return a}const r=C(()=>t.expandTrigger==="click"?()=>{var a;const{value:f}=n;f&&((a=v.value)===null||a===void 0||a.setShow(!1)),n.value=!f}:void 0);ie(()=>{var a;t.tooltip&&((a=v.value)===null||a===void 0||a.setShow(!1))});const d=()=>L("span",Object.assign({},re(c,{class:[`${s.value}-ellipsis`,t.lineClamp!==void 0?A(s.value):void 0,t.expandTrigger==="click"?M(s.value,"pointer"):void 0],style:o.value}),{ref:"triggerRef",onClick:r.value,onMouseenter:t.expandTrigger==="click"?i:void 0}),t.lineClamp?l:L("span",{ref:"triggerInnerRef"},l));function g(a){if(!a)return;const f=o.value,m=A(s.value);t.lineClamp!==void 0?x(a,m,"add"):x(a,m,"remove");for(const h in f)a.style[h]!==f[h]&&(a.style[h]=f[h])}function T(a,f){const m=M(s.value,"pointer");t.expandTrigger==="click"&&!f?x(a,m,"add"):x(a,m,"remove")}function x(a,f,m){m==="add"?a.classList.contains(f)||a.classList.add(f):a.classList.contains(f)&&a.classList.remove(f)}return{mergedTheme:u,triggerRef:b,triggerInnerRef:p,tooltipRef:v,handleClick:r,renderTrigger:d,getTooltipDisabled:i}},render(){var t;const{tooltip:l,renderTrigger:c,$slots:s}=this;if(l){const{mergedTheme:u}=this;return L(ge,Object.assign({ref:"tooltipRef",placement:"top"},l,{getDisabled:this.getTooltipDisabled,theme:u.peers.Tooltip,themeOverrides:u.peerOverrides.Tooltip}),{trigger:c,default:(t=s.tooltip)!==null&&t!==void 0?t:s.default})}else return c()}}),O=B({name:"Text",props:{text:{type:[String,Number],default:""},placeholder:{type:String,default:"-"}},setup(t){const{text:l,placeholder:c}=S(t),s=()=>{const u=String(l.value);return u||c.value};return()=>s()}}),Ie="_item_1fqoq_1",_={"book-details":"_book-details_1fqoq_1",item:Ie,"book-cover-image":"_book-cover-image_1fqoq_10"},Ce=B({name:"BookDetails",props:{bookData:{type:Object,default:()=>({})},onRateChange:{type:Function}},setup(t){const{bookData:l}=S(t),{t:c}=N({useScope:"global"}),s=C(()=>{var b,p,v;const u=(p=(b=l.value)==null?void 0:b.covers)==null?void 0:p[0];return J(u,(v=l.value)==null?void 0:v.title)});return()=>{var u,b,p,v,n,o,i,r,d;return e("div",{class:y(_["book-details"])},[e("h1",null,[(u=l.value)==null?void 0:u.title]),e("p",null,[(b=l.value)==null?void 0:b.isbn]),e("p",null,[c("pages.book.preview.detail.author"),E("："),I((p=l.value)==null?void 0:p.authors,c("pages.book.preview.detail.noAuthor"),_.item)]),e("p",null,[e(ve,{value:(v=l.value)==null?void 0:v.rating,allowHalf:!0,onUpdateValue:t.onRateChange,readonly:!0},null)]),e("p",null,[e(me,{class:y(_["book-cover-image"]),src:s.value,renderToolbar:({nodes:g})=>e(W,null,[g.zoomIn,g.resizeToOriginalSize,g.zoomOut])},null)]),e("h3",null,[c("pages.book.preview.detail.details")]),e("p",null,[I((n=l.value)==null?void 0:n.publishers,c("pages.book.preview.detail.noPublisher"),_.item)]),e("p",null,[E("出版时间： "),e(O,{text:(o=l.value)==null?void 0:o.publishDate},null)]),e("p",null,[I((i=l.value)==null?void 0:i.languages,c("pages.book.preview.detail.noLanguage"),_.item)]),e("p",null,[e(ce,{scope:"global",keypath:"pages.book.preview.detail.numberOfPages.text"},{default:()=>{var g;return[e(O,{text:(g=l.value)==null?void 0:g.numberOfPages,placeholder:c("pages.book.preview.detail.numberOfPages.placeholder")},null)]}})]),e("p",null,[I((r=l.value)==null?void 0:r.tags,c("pages.book.preview.detail.noTags"),_.item)]),e("p",null,[I((d=l.value)==null?void 0:d.subjects,c("pages.book.preview.detail.noSubject"),_.item)]),e("p",null,[e("h3",null,[c("pages.book.preview.detail.summary")]),e("div",null,[e(xe,{expandTrigger:"click",lineClamp:5,tooltip:!1},{default:()=>{var g;return[e(O,{text:(g=l.value)==null?void 0:g.summary},null)]}})])])])}}}),Se="_flip_1j32v_23",U={"duplicate-books-icon":"_duplicate-books-icon_1j32v_1",flip:Se},Te=B({name:"DuplicateBooksIcon",props:{cover:{type:Blob},title:{type:String}},setup(t){const{cover:l,title:c}=S(t),s=C(()=>J(l.value,c.value)),u=k(!1);return setTimeout(()=>{ue(()=>{u.value=!0})},1e3),()=>e("div",{class:y(U["duplicate-books-icon"],{[U.flip]:u.value}),style:{"--background-image":`url(${s.value})`}},["⬜️"])}}),j={"bookcase-preview-container":"_bookcase-preview-container_1pkbt_1","bookcase-preview":"_bookcase-preview_1pkbt_1","bookcase-preview-image":"_bookcase-preview-image_1pkbt_15"},Le=B({name:"BookcasePreview",props:{bookcaseId:{type:String,required:!1},selectedCellId:{type:String,required:!1},isLocated:{type:Boolean,default:!1},onSizeLoad:{type:Function,required:!1}},setup(t){const{bookcaseId:l,selectedCellId:c,isLocated:s}=S(t),{t:u}=N({useScope:"global"}),b=k();P(()=>l.value,o=>{o&&$.bookcase.queryBookcaseById(o).then(i=>{i&&(v(i),b.value=i.name)})},{immediate:!0});const p=k();function v(o){const{meta:i,cells:r}=o,{unit:d,fill:g,fillSelected:T}=i,x=(i.width*d||300)+4,a=(i.height*d||300)+4,f=new D.Stage({container:document.createElement("div"),x:2,y:2,width:x,height:a,draggable:!1}),m=new D.Layer;f.add(m),r.forEach(h=>{const{from:w,to:q,id:Y}=h,Z=w[0]*d,Q=w[1]*d,X=(q[1]-w[1])*d,ee=(q[0]-w[0])*d,te=new D.Rect({y:Q,x:Z,width:ee,height:X,fill:Y===c.value?T:g,cell:{...h},...ye});m.add(te),m.draw()}),f.toBlob({}).then(h=>{p.value=h})}const n=o=>{var d,g;const r=(d=o.target.parentElement)==null?void 0:d.parentElement;(g=t.onSizeLoad)==null||g.call(t,r.clientWidth,r.clientHeight)};return()=>e("div",{class:y(j["bookcase-preview-container"])},[e("div",{class:y(j["bookcase-preview"])},[e("img",{class:y(j["bookcase-preview-image"]),src:p.value&&URL.createObjectURL(p.value),alt:b.value,onLoad:n},null),e("div",null,[e("span",null,[b.value]),e("span",null,[s.value?u("pages.bookcase.preview.current"):""])])])])}}),V={"book-location":"_book-location_1s333_1","preview-card":"_preview-card_1s333_7"},Re=B({name:"BookLocation",props:{bookcaseIds:{type:Array,default:()=>[]}},setup(t){const{router:l}=G(),c=k([]),s=k(!1),u=k([]),b=k(0);return P(c.value,p=>{if(p.filter(v=>v!==void 0).length===t.bookcaseIds.length){s.value=!0;const v=[],n=[0,0];for(let o=0;o<p.length;o++)n[0]<=n[1]?(v.push([0,n[0]]),n[0]+=p[o]):(v.push([1,n[1]]),n[1]+=p[o]);u.value=v,b.value=Math.max(...n)}}),()=>e("div",{class:y(V["book-location"]),style:{height:`${b.value}px`}},[t.bookcaseIds.map((p,v)=>{const n=u.value[v]||[0,0],o=n[0]===0?"0%":"100%",i=n[1]+"px";return e("div",{class:y(V["preview-card"]),style:{visibility:s.value?"visible":"hidden",transform:`translate(${o}, ${i})`},onClick:()=>{l.push(`/cell/${p.cellId}`)}},[e(Le,{key:p.bookcaseId,bookcaseId:p.bookcaseId,selectedCellId:p.cellId,onSizeLoad:(r,d)=>{c.value[v]=d},isLocated:v===0},null)])})])}}),De={"preview-book":"_preview-book_ozp5a_1"};function H(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!pe(t)}const Ae=B({name:"PreviewBook",setup(){const{t}=N({useScope:"global"}),{route:l,router:c}=G(),s=k(),u=k([]);P(()=>l.params,n=>{const{isbn:o,id:i}=n;i?$.book.queryRelatedBooksByBookId(i).then(r=>{if(r!=null&&r.length){const[d,...g]=r;s.value=d,u.value=g||[]}}):o&&$.book.queryFirstBookByIsbn(o).then(r=>{if(r!=null&&r.length){const[d,...g]=r;s.value=d,u.value=g||[]}})},{immediate:!0});function b(){var o;const n=(o=s.value)==null?void 0:o.id;n&&c.push({path:`/book/edit/id/${n}`,replace:!0})}const p=n=>e("div",{class:y(De["preview-book"])},[e(be,{topBar:e(z,{rightSlots:[u.value.length?e(R,{onClick:n},{default:()=>{var o,i,r;return[e(Te,{cover:(i=(o=s.value)==null?void 0:o.covers)==null?void 0:i[0],title:(r=s.value)==null?void 0:r.title},null)]}}):e(W,null,null),e(R,{onClick:b},{default:()=>[e(de,{name:"pencil"},null)]})]},{default:()=>{var o;return[((o=s.value)==null?void 0:o.title)||"-"]}})},{default:()=>[e(Ce,{bookData:s.value},null)]})]),v=n=>{let o,i;const r=[s.value,...u.value].filter(d=>!!d).map(d=>({bookcaseId:d.bookcaseId,cellId:d.cellId}));return e(he,{topBar:e(z,{leftSlots:[e(R,{text:!0,onClick:n},H(o=t("common.close"))?o:{default:()=>[o]})]},H(i=t("pages.book.preview.decker.topbar.title"))?i:{default:()=>[i]})},{default:()=>[e(Re,{bookcaseIds:r},null)]})};return()=>e(ke,null,{default:p,decker:v})}});export{Ae as default};
//# sourceMappingURL=PreviewBook-B-17FEEA.js.map
